<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>Telegram Premium - é«˜çº§è®¢é˜…æœåŠ¡</title>

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

    <style>
        /*ï¼ˆä¿ç•™å¹¶ç•¥å¾®è°ƒæ•´åŸæ ·å¼ï¼‰*/
        *{margin:0;padding:0;box-sizing:border-box}
        html{font-size:16px}
        @media (max-width:480px){html{font-size:14px}}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
            color:#fff;min-height:100vh;padding:1rem;line-height:1.5;overflow-x:hidden;
        }
        .container{width:100%;max-width:28rem;margin:0 auto;padding:0.5rem}
        .header{text-align:center;margin-bottom:2rem}
        .header h1{font-size:1.8rem;margin-bottom:0.5rem;background:linear-gradient(90deg,#ffd700,#ff8c00);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700}
        .pricing-card{background:rgba(255,255,255,0.08);backdrop-filter:blur(8px);border-radius:1.25rem;padding:1.5rem;margin:0 auto;box-shadow:0 0.5rem 2rem rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);text-align:center}
        .price{font-size:2.5rem;font-weight:700;margin:1rem 0;color:#ffd700}
        .btn{display:inline-block;background:linear-gradient(90deg,#ff8c00,#ffd700);color:#1e3c72;padding:1rem 1.5rem;border-radius:3rem;text-decoration:none;font-weight:600;font-size:1.05rem;border:none;cursor:pointer;width:100%;margin-bottom:1rem}
        .btn:disabled{background:#666;cursor:not-allowed;opacity:0.6}
        .form-container{display:none;margin-top:1.5rem;text-align:left}
        .form-group{margin-bottom:1.25rem}
        label{display:block;margin-bottom:0.5rem;font-weight:500}
        input{width:100%;padding:1rem;border-radius:0.75rem;border:1px solid rgba(255,255,255,0.16);background:rgba(255,255,255,0.04);color:#fff;font-size:1rem;min-height:3.5rem}
        .wallet-container{display:none;margin-top:1.5rem;text-align:left}
        .wallet-options{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin:1rem 0 1.5rem 0}
        .wallet-option{background:rgba(255,255,255,0.06);border-radius:.75rem;padding:1.25rem 0.5rem;text-align:center;cursor:pointer;border:2px solid transparent;min-height:5rem;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .wallet-status{background:rgba(255,255,255,0.06);border-radius:.75rem;padding:1rem;margin:1rem 0;text-align:center;font-size:.9rem}
        .wallet-status.connected{background:rgba(0,255,0,0.06);border:1px solid rgba(0,255,0,0.18)}
        .wallet-status.error{background:rgba(255,0,0,0.06);border:1px solid rgba(255,0,0,0.18)}
        .temporary-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#fff;padding:1rem 2rem;border-radius:.75rem;z-index:1000;text-align:center;max-width:80%}
        .row{display:flex;gap:.5rem}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Telegram é«˜çº§è®¢é˜…æœåŠ¡</h1>
            <p>ä½¿ç”¨æ‚¨çš„åŠ å¯†è´§å¸é’±åŒ…è·å– Telegram Premium è®¢é˜…</p>
        </div>

        <div class="pricing-card">
            <div class="pricing-header">
                <h2>Telegram Premium</h2>
                <div class="price">$1.99<span style="font-size:1rem;color:rgba(255,255,255,0.85)"></span></div>
                <p class="description">ä¸ºæ‚¨è‡ªå·±æˆ–å¥½å‹å…‘æ¢ Premium æƒç›Š</p>
            </div>

            <button id="purchaseBtn" class="btn">ç«‹å³è´­ä¹°</button>

            <div id="userForm" class="form-container">
                <div class="step"><div class="step-number">1</div><div class="step-text">å¡«å†™æ¥æ”¶ Premium çš„ Telegram ç”¨æˆ·ä¿¡æ¯</div></div>

                <div class="form-group">
                    <label for="username">Telegram ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="ä¾‹å¦‚: @username" required>
                </div>
                <div class="form-group">
                    <label for="nickname">ç”¨æˆ·æ˜µç§°</label>
                    <input type="text" id="nickname" placeholder="ä¾‹å¦‚: å¼ ä¸‰" required>
                </div>

                <button id="confirmBtn" class="btn">ä¸‹ä¸€æ­¥ â€” è¿æ¥é’±åŒ…</button>
            </div>

            <div id="walletSection" class="wallet-container">
                <div class="step"><div class="step-number">2</div><div class="step-text">é€‰æ‹©å¹¶è¿æ¥é’±åŒ…ï¼ˆEVM / TRON æ”¯æŒï¼‰</div></div>

                <div id="walletStatus" class="wallet-status">æ£€æµ‹é’±åŒ…...</div>

                <div style="margin:8px 0;font-size:0.9rem;opacity:0.95">
                    <strong>ç½‘ç«™åŸŸåï¼š</strong><span id="siteDomain"></span>
                </div>

                <div class="row">
                    <button id="connectWalletBtn" class="btn">è¿æ¥é’±åŒ…</button>
                    <button id="preparePayBtn" class="btn" disabled>ç¡®è®¤å¹¶é¢„è§ˆäº¤æ˜“</button>
                </div>

                <div class="wallet-options">
                    <div class="wallet-option" onclick="selectWallet('MetaMask')"><div class="wallet-icon">ğŸ¦Š</div><div class="wallet-name">MetaMask</div></div>
                    <div class="wallet-option" onclick="selectWallet('TronLink')"><div class="wallet-icon">âš¡</div><div class="wallet-name">TronLink</div></div>
                    <div class="wallet-option" onclick="selectWallet('WalletConnect')"><div class="wallet-icon">ğŸ”—</div><div class="wallet-name">WalletConnect</div></div>
                    <div class="wallet-option" onclick="selectWallet('Other')"><div class="wallet-icon">ğŸ”’</div><div class="wallet-name">å…¶ä»–</div></div>
                </div>
            </div>

        </div>
    </div>

    <script>
    /**
     * æ”¹è¿›è¦ç‚¹å®ç°ï¼š
     * - Web3.js åˆå§‹åŒ–ä¸å…¼å®¹æ£€æµ‹
     * - åŸŸåæ˜¾ç¤ºï¼ˆwindow.location.hostnameï¼‰
     * - EIP-712 (eth_signTypedData_v4) ç”¨äºè®©é’±åŒ…æ˜¾ç¤ºåŸŸå/æ¥æºï¼ˆtypedData è¯·æ±‚ï¼‰
     * - personal_sign + web3.eth.personal.ecRecover åšå®¢æˆ·ç«¯å¯éªŒè¯ç­¾å
     * - ç½‘ç»œæ£€æŸ¥ï¼ˆæ”¯æŒ ETH ä¸»ç½‘ / BSC / Polygon / TRONï¼‰
     * - äº¤æ˜“é¢„è§ˆé€šè¿‡ eth_sendTransaction è°ƒç”¨å‘èµ·ï¼ˆé’±åŒ…ä¼šå¼¹çª—æ˜¾ç¤ºå®Œæ•´ txï¼‰
     * - äº‹ä»¶ç›‘å¬ accountsChanged / chainChanged
     * - å‹å¥½é”™è¯¯å¤„ç†æç¤º
     */

    // === é…ç½®é¡¹ï¼ˆè¯·æ›¿æ¢æ”¶æ¬¾åœ°å€ï¼‰ ===
    const RECEIVER_ADDRESS_ETH = '0x742EfB6A78A0b5c0e5c5F8c5B8c5c5F8c5B8c5c5F'; // ç¤ºä¾‹ ETH åœ°å€ï¼ˆæ›¿æ¢ï¼‰
    const RECEIVER_ADDRESS_TRON = 'TCSmW3PZTPaog8d2CKBstcFNcGGtyf9Jub'; // ç¤ºä¾‹ TRON åœ°å€ï¼ˆæ›¿æ¢ï¼‰
    const ACCEPTED_CHAIN_IDS = { 1: 'Ethereum Mainnet', 56: 'BSC Mainnet', 137: 'Polygon Mainnet' }; // æ”¯æŒé“¾
    const PAYMENT_AMOUNT_ETH_WEI = null; // å¯æŒ‰éœ€æ±‚åŠ¨æ€è®¾ç½®ï¼ˆç¤ºä¾‹ä¸­æŒ‰ ETH å€¼è®¡ç®—ï¼‰

    // çŠ¶æ€
    let web3 = null;
    let userAddress = null;
    let selectedWallet = null;
    let currentChainId = null;
    let orderData = null;

    // UI helpers
    function showTemporaryMessage(text, timeout=3000) {
        const ex = document.querySelector('.temporary-message');
        if (ex) ex.remove();
        const div = document.createElement('div'); div.className='temporary-message'; div.textContent=text;
        document.body.appendChild(div);
        setTimeout(()=>{ if (div.parentNode) div.remove(); }, timeout);
    }
    function updateWalletStatus(text, type='') {
        const el = document.getElementById('walletStatus');
        el.textContent = text;
        el.className = 'wallet-status' + (type ? ' ' + type : '');
    }

    // åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º domain
    document.getElementById('siteDomain').textContent = window.location.hostname;

    // é€‰æ‹©é’±åŒ…ç±»å‹ï¼ˆåªæ˜¯æ˜¾ç¤ºç”¨é€”ï¼Œå®é™…ä½¿ç”¨window.ethereumæˆ–tronWebï¼‰
    function selectWallet(name) {
        selectedWallet = name;
        updateWalletStatus(`å·²é€‰æ‹©: ${name}ï¼Œè¯·ç‚¹å‡»ã€Œè¿æ¥é’±åŒ…ã€æŒ‰é’®`, '');
    }
    window.selectWallet = selectWallet;

    // åˆå§‹åŒ– Web3ï¼šæ£€æµ‹ window.ethereum / tronWeb
    async function initWeb3() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                // ç»‘å®šäº‹ä»¶
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (!accounts || accounts.length === 0) {
                        userAddress = null;
                        updateWalletStatus('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'error');
                        document.getElementById('preparePayBtn').disabled = true;
                    } else {
                        userAddress = accounts[0];
                        updateWalletStatus(`å·²è¿æ¥: ${userAddress.substring(0,8)}...`, 'connected');
                        document.getElementById('preparePayBtn').disabled = false;
                    }
                });
                window.ethereum.on('chainChanged', (chainIdHex) => {
                    const chainId = parseInt(chainIdHex, 16);
                    currentChainId = chainId;
                    checkNetwork(chainId);
                });
                return true;
            } catch (e) {
                console.error('initWeb3 error', e);
                updateWalletStatus('Web3 åˆå§‹åŒ–å¤±è´¥: '+ (e.message||e), 'error');
                return false;
            }
        } else if (window.tronWeb && window.tronWeb.ready) {
            updateWalletStatus(`æ£€æµ‹åˆ° TronLink`, 'connected');
            return true;
        } else {
            updateWalletStatus('æœªæ£€æµ‹åˆ° Web3 é’±åŒ…ï¼Œè¯·å®‰è£… MetaMask/TronLink æˆ–ä½¿ç”¨ç§»åŠ¨ç«¯ DApp æµè§ˆå™¨', 'error');
            return false;
        }
    }

    // ç½‘ç»œæ£€æŸ¥
    function checkNetwork(chainId) {
        if (!chainId) {
            updateWalletStatus('æ— æ³•æ£€æµ‹é“¾ID', 'error'); return false;
        }
        if (!Object.keys(ACCEPTED_CHAIN_IDS).map(x=>parseInt(x)).includes(chainId)) {
            updateWalletStatus(`å½“å‰ç½‘ç»œï¼ˆID:${chainId}ï¼‰ä¸å—æ”¯æŒï¼Œè¯·åˆ‡æ¢åˆ° ETH/BSC/Polygon ç­‰æ”¯æŒç½‘ç»œ`, 'error');
            return false;
        }
        updateWalletStatus(`å½“å‰ç½‘ç»œï¼š${ACCEPTED_CHAIN_IDS[chainId]}ï¼ˆID:${chainId}ï¼‰`, 'connected');
        return true;
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
        // ä¼˜å…ˆ EVM é’±åŒ…
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                web3 = new Web3(window.ethereum);
                currentChainId = await web3.eth.getChainId();
                if (!checkNetwork(currentChainId)) {
                    // ä¸æ”¯æŒç½‘ç»œä½†ä»è¿æ¥ï¼Œå¯æç¤ºç”¨æˆ·åˆ‡æ¢
                }
                updateWalletStatus(`âœ… å·²è¿æ¥ï¼š${userAddress.substring(0,8)}...ï¼ˆID:${currentChainId}ï¼‰`, 'connected');
                document.getElementById('preparePayBtn').disabled = false;
                showTemporaryMessage('é’±åŒ…è¿æ¥æˆåŠŸï¼');
                return;
            } catch (err) {
                console.error('connectWallet', err);
                if (err.code===4001) updateWalletStatus('ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚', 'error');
                else updateWalletStatus('è¿æ¥å¤±è´¥: '+(err.message||err), 'error');
                return;
            }
        }

        // TronLink
        if (window.tronWeb && window.tronWeb.ready) {
            userAddress = window.tronWeb.defaultAddress.base58;
            updateWalletStatus(`âœ… å·²è¿æ¥ Tron: ${userAddress}`, 'connected');
            document.getElementById('preparePayBtn').disabled = false;
            return;
        }

        updateWalletStatus('æœªæ£€æµ‹åˆ°æ”¯æŒçš„é’±åŒ…', 'error');
    }

    // ç”Ÿæˆè®¢å•æ•°æ®
    function makeOrder(username, nickname) {
        return {
            orderId: 'TG'+Date.now().toString(36).toUpperCase(),
            username: username,
            nickname: nickname,
            amountUSD: '1.99',
            timestamp: Date.now(),
            site: window.location.hostname
        };
    }

    // ä¸»æµç¨‹ï¼šå‡†å¤‡å¹¶é¢„è§ˆäº¤æ˜“ï¼ˆå…ˆåšç­¾åéªŒè¯ï¼Œå†è°ƒç”¨é’±åŒ…å‘èµ·äº¤æ˜“é¢„è§ˆï¼‰
    async function prepareAndPreviewPayment() {
        if (!userAddress) { showTemporaryMessage('è¯·å…ˆè¿æ¥é’±åŒ…'); return; }
        const username = document.getElementById('username').value.trim();
        const nickname = document.getElementById('nickname').value.trim();
        if (!username || !nickname) { showTemporaryMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
        if (!username.startsWith('@')) { showTemporaryMessage('ç”¨æˆ·åéœ€ä»¥ @ å¼€å¤´'); return; }

        orderData = makeOrder(username, nickname);

        try {
            // 1) è¯·æ±‚ç”¨æˆ·å¯¹ EIP-712 typedData è¿›è¡Œç­¾åï¼ˆè¿™ä¸ªè¯·æ±‚ä¼šåœ¨å¼¹çª—é‡Œå±•ç¤º domain -> é€šå¸¸é’±åŒ…ä¼šæ˜¾ç¤ºæ¥æºåŸŸåï¼‰
            // typedData v4 ç»“æ„
            const chainId = currentChainId || await web3.eth.getChainId();
            const typedData = {
                "types": {
                    "EIP712Domain":[
                        {"name":"name","type":"string"},
                        {"name":"version","type":"string"},
                        {"name":"chainId","type":"uint256"},
                        {"name":"verifyingContract","type":"string"}
                    ],
                    "Order":[
                        {"name":"orderId","type":"string"},
                        {"name":"username","type":"string"},
                        {"name":"nickname","type":"string"},
                        {"name":"amountUSD","type":"string"},
                        {"name":"timestamp","type":"uint256"}
                    ]
                },
                "domain":{"name":"TelegramPremiumDApp","version":"1","chainId":chainId,"verifyingContract":window.location.hostname},
                "primaryType":"Order",
                "message": {
                    orderId: orderData.orderId,
                    username: orderData.username,
                    nickname: orderData.nickname,
                    amountUSD: orderData.amountUSD,
                    timestamp: Math.floor(orderData.timestamp/1000)
                }
            };

            // è¯·æ±‚ EIP-712 ç­¾åï¼ˆç”¨äºåœ¨é’±åŒ…å¼¹çª—æ˜¾ç¤ºåŸŸåæ¥æºï¼‰
            const from = userAddress;
            let typedSig;
            try {
                typedSig = await window.ethereum.request({
                    method: 'eth_signTypedData_v4',
                    params: [from, JSON.stringify(typedData)]
                });
            } catch (e) {
                console.warn('ç”¨æˆ·å¯èƒ½æ‹’ç» typedData ç­¾åæˆ–é’±åŒ…ä¸æ”¯æŒ eth_signTypedData_v4', e);
                // æˆ‘ä»¬ä¸ä¼šå¼ºåˆ¶å¤±è´¥ï¼Œæ”¹ä¸ºåç»­ä½¿ç”¨ personal_sign
            }

            // 2) ä¸ºäº†èƒ½åœ¨å®¢æˆ·ç«¯éªŒè¯ç­¾åï¼Œæˆ‘ä»¬åŒæ—¶è¯·æ±‚ personal_signï¼ˆå¯¹ä¸€ä¸ª message hashï¼‰ï¼Œå¹¶ä½¿ç”¨ web3.eth.personal.ecRecover éªŒè¯
            const payloadStr = JSON.stringify({
                orderId: orderData.orderId,
                username: orderData.username,
                nickname: orderData.nickname,
                amountUSD: orderData.amountUSD,
                timestamp: orderData.timestamp,
                site: window.location.hostname
            });
            const msgHash = web3.utils.sha3(payloadStr); // hex string
            // ä½¿ç”¨ personal_sign
            let personalSig;
            try {
                personalSig = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [msgHash, from]
                });
            } catch (e) {
                console.error('personal_sign è¢«æ‹’ç»æˆ–å¤±è´¥', e);
                showTemporaryMessage('è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ç­¾åä»¥ç»§ç»­');
                return;
            }

            // éªŒè¯ç­¾åï¼ˆecRecoverï¼‰
            let recovered;
            try {
                recovered = await web3.eth.personal.ecRecover(msgHash, personalSig);
            } catch (e) {
                console.error('ecRecover å¤±è´¥', e);
            }

            if (!recovered || recovered.toLowerCase() !== from.toLowerCase()) {
                showTemporaryMessage('ç­¾åæ ¡éªŒå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ›´æ¢é’±åŒ…', 4000);
                return;
            }

            // ç­¾åé€šè¿‡ â€”â€” å°†ç­¾åå­˜å…¥ orderDataï¼ˆå¯å‘é€ç»™åç«¯ï¼‰
            orderData.signature = personalSig;
            orderData.typedSignature = typedSig || null;

            // 3) é¢„è§ˆæ„å»ºäº¤æ˜“å‚æ•°ï¼ˆå‘é€äº¤æ˜“å‰è®©ç”¨æˆ·åœ¨é’±åŒ…é‡Œç¡®è®¤ï¼šé’±åŒ…å°†æ˜¾ç¤º to/amount/dataï¼‰
            // è¿™é‡Œæˆ‘ä»¬ä»¥ ETH è½¬è´¦ä¸ºä¾‹ï¼šæŠŠ USD é‡‘é¢æ¢æˆ ETH å¯ç”±å‰ç«¯æˆ–åç«¯æ±‡ç‡æœåŠ¡è®¡ç®—ã€‚ä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬ä¼ å…¥å›ºå®šæå°å€¼
            // IMPORTANT: åœ¨çœŸå®ç¯å¢ƒï¼Œè¯·æ›¿æ¢ä¸ºå‡†ç¡®çš„é‡‘é¢æ¢ç®—é€»è¾‘
            const txValueWei = web3.utils.toWei('0.001', 'ether'); // ç¤ºä¾‹ï¼š0.001 ETH (æ¼”ç¤º)
            const txParams = {
                from: from,
                to: RECEIVER_ADDRESS_ETH,
                value: web3.utils.toHex(txValueWei),
                gas: web3.utils.toHex(21000),
                data: web3.utils.toHex(`Telegram premium:${orderData.username}`)
            };

            // 4) ä½¿ç”¨ eth_sendTransaction å‘èµ·é’±åŒ…å¼¹çª—ï¼ˆç”¨æˆ·åœ¨é’±åŒ…ä¸­å¯æŸ¥çœ‹å®Œæ•´äº¤æ˜“è¯¦æƒ…å¹¶ç¡®è®¤ç­¾åå‘åˆ°é“¾ä¸Šï¼‰
            showTemporaryMessage('é’±åŒ…å°†å¼¹å‡ºäº¤æ˜“é¢„è§ˆï¼Œè¯·åœ¨é’±åŒ…ä¸­æ ¸å¯¹å¹¶ç¡®è®¤');
            const txHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [txParams]
            });

            // æ˜¾ç¤ºæäº¤æˆåŠŸæç¤ºï¼›å»ºè®®å°† orderData å’Œ txHash å‘é€åˆ°åç«¯ä¿å­˜
            showTemporaryMessage('äº¤æ˜“å·²æäº¤ï¼š' + txHash, 5000);
            console.log('è®¢å•ç”Ÿæˆ', orderData, 'txHash', txHash);

            // è·³è½¬åˆ° order é¡µé¢å±•ç¤ºè¯¦æƒ…ï¼ˆå¯ä»¥æºå¸¦ orderId & txHash & usernameï¼‰
            const query = new URLSearchParams({
                orderId: orderData.orderId,
                username: encodeURIComponent(orderData.username),
                nickname: encodeURIComponent(orderData.nickname),
                txHash: txHash
            });
            setTimeout(()=>{ window.location.href = 'order.html?' + query.toString(); }, 1200);

        } catch (err) {
            console.error('prepareAndPreviewPayment error', err);
            showTemporaryMessage('å¤„ç†å¤±è´¥: ' + (err.message || err), 4000);
        }
    }

    // DOM bindings
    document.addEventListener('DOMContentLoaded', async () => {
        await initWeb3();

        document.getElementById('purchaseBtn').addEventListener('click', () => {
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('purchaseBtn').style.display = 'none';
        });

        document.getElementById('confirmBtn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const n = document.getElementById('nickname').value.trim();
            if (!u || !n) { showTemporaryMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
            if (!u.startsWith('@')) { showTemporaryMessage('ç”¨æˆ·åå¿…é¡»ä»¥ @ å¼€å¤´'); return; }
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('walletSection').style.display = 'block';
            updateWalletStatus('è¯·é€‰æ‹©é’±åŒ…å¹¶è¿æ¥');
        });

        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('preparePayBtn').addEventListener('click', prepareAndPreviewPayment);

        // å¦‚æœé¡µé¢åŠ è½½æ—¶å·²ç»è¿æ¥
        if (window.ethereum && window.ethereum.selectedAddress) {
            userAddress = window.ethereum.selectedAddress;
            web3 = new Web3(window.ethereum);
            currentChainId = await web3.eth.getChainId();
            updateWalletStatus(`å·²è¿æ¥: ${userAddress.substring(0,8)}...`, 'connected');
            document.getElementById('walletSection').style.display = 'block';
            document.getElementById('purchaseBtn').style.display = 'none';
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('preparePayBtn').disabled = false;
        }

        // TronLink ç›‘å¬
        if (window.tronWeb) {
            window.addEventListener('message', (e)=>{
                // è‹¥éœ€å¯æ‰©å±•
            });
        }
    });

    </script>
</body>
</html>
