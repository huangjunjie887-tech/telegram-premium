<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>支付确认 - Telegram Premium</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 28rem;
            margin: 0 auto;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 3rem;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .debug-info {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="order-card">
            <h2>支付确认</h2>
            <div id="orderInfo">
                <p>用户名: <span id="username">-</span></p>
                <p>昵称: <span id="nickname">-</span></p>
                <p>金额: $<span id="amount">1.99</span></p>
            </div>
            
            <div id="paymentInfo">
                <p>收款地址: TCSmW3PZTPaog8d2CKBstcFNcGGtyf9Jub</p>
                <p>网络: TRON (TRC20)</p>
            </div>
            
            <button id="payBtn" class="btn" onclick="processPayment()">确认支付</button>
            <div id="paymentStatus"></div>
        </div>

        <div class="debug-info">
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        let walletType = '';
        let deviceType = '';
        let userAccount = null;

        // 检测钱包类型和设备
        function detectWalletAndDevice() {
            const ua = navigator.userAgent.toLowerCase();
            
            if (ua.includes('tokenpocket')) walletType = "TokenPocket";
            else if (ua.includes('imtoken')) walletType = "imToken";
            else if (ua.includes('metamask')) walletType = "MetaMask";
            else if (ua.includes('bitkeep') || ua.includes('bitget')) walletType = "Bitget";
            else walletType = "未知钱包";
            
            if (/iphone|ipad|ipod/.test(ua)) deviceType = "iOS";
            else if (/android/.test(ua)) deviceType = "Android";
            else deviceType = "其他设备";
            
            document.getElementById('debugContent').innerHTML = `
                钱包: ${walletType} | 设备: ${deviceType}<br>
                URL参数: ${window.location.search}
            `;
        }

        // 自动连接钱包
        function autoConnectWallet() {
            if (window.ethereum || window.tronWeb) {
                connectWallet();
            } else {
                setTimeout(autoConnectWallet, 500);
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                if (window.tronWeb) {
                    // TronLink 钱包
                    let retryCount = 0;
                    const checkTronLink = setInterval(() => {
                        if (window.tronWeb && window.tronWeb.defaultAddress) {
                            clearInterval(checkTronLink);
                            userAccount = window.tronWeb.defaultAddress.base58;
                            document.getElementById('debugContent').innerHTML += `<br>已连接: ${userAccount}`;
                        } else if (retryCount >= 10) {
                            clearInterval(checkTronLink);
                        }
                        retryCount++;
                    }, 500);
                } else if (window.ethereum) {
                    // Ethereum 钱包
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        document.getElementById('debugContent').innerHTML += `<br>已连接: ${userAccount}`;
                    }
                }
            } catch (error) {
                console.error('连接钱包失败:', error);
            }
        }

        // 处理支付
        async function processPayment() {
            if (!userAccount) {
                alert('请先连接钱包');
                return;
            }

            try {
                document.getElementById('payBtn').disabled = true;
                document.getElementById('payBtn').textContent = '支付中...';

                if (window.tronWeb) {
                    const transaction = await window.tronWeb.transactionBuilder.sendTrx(
                        'TCSmW3PZTPaog8d2CKBstcFNcGGtyf9Jub',
                        1990000, // 1.99 USDT
                        userAccount
                    );
                    
                    const signedTransaction = await window.tronWeb.trx.sign(transaction);
                    const result = await window.tronWeb.trx.sendRawTransaction(signedTransaction);
                    
                    document.getElementById('paymentStatus').innerHTML = '<p style="color: #4CAF50;">支付成功！</p>';
                } else {
                    alert('请使用TronLink钱包');
                }
            } catch (error) {
                document.getElementById('paymentStatus').innerHTML = `<p style="color: #f44336;">支付失败: ${error.message}</p>`;
                document.getElementById('payBtn').disabled = false;
                document.getElementById('payBtn').textContent = '确认支付';
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            detectWalletAndDevice();
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username') || urlParams.get('u');
            const nickname = urlParams.get('nickname') || urlParams.get('n');
            
            if (username && nickname) {
                document.getElementById('username').textContent = decodeURIComponent(username);
                document.getElementById('nickname').textContent = decodeURIComponent(nickname);
                // 自动连接钱包
                autoConnectWallet();
            } else {
                document.getElementById('paymentStatus').innerHTML = '<p style="color: #f44336;">参数错误，请返回重试</p>';
            }
        });
    </script>
</body>
</html>