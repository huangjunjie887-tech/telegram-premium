<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>支付授权 - Telegram Premium</title>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#fff;min-height:100vh;padding:1rem;line-height:1.5}
        .container{max-width:28rem;margin:0 auto}
        .header{text-align:center;margin-bottom:1.5rem}
        .header h1{font-size:1.6rem;color:#ffd700;margin-bottom:.25rem}
        .order-card{background:rgba(255,255,255,0.08);backdrop-filter:blur(8px);border-radius:1.25rem;padding:1.25rem;border:1px solid rgba(255,255,255,0.06)}
        .info-item{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid rgba(255,255,255,0.06)}
        .info-label{opacity:.9}
        .info-value{color:#ffd700;font-weight:600}
        .btn{display:block;width:100%;background:linear-gradient(90deg,#ff8c00,#ffd700);color:#1e3c72;padding:1rem;border-radius:3rem;border:none;font-weight:600;margin-top:1rem;cursor:pointer}
        .btn:disabled{background:#666;cursor:not-allowed}
        .wallet-status{margin:1rem 0;padding:1rem;border-radius:.75rem;background:rgba(255,255,255,0.06)}
        .success{background:rgba(0,255,0,0.06);border:1px solid rgba(0,255,0,0.12)}
        .error{background:rgba(255,0,0,0.06);border:1px solid rgba(255,0,0,0.12)}
        .spinner{border:3px solid rgba(255,255,255,0.2);border-top:3px solid #ffd700;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>支付授权</h1><p>请在钱包中确认支付并查看结果</p></div>

        <div class="order-card" id="orderCard">
            <div class="info-item"><span class="info-label">订单号</span><span class="info-value" id="orderId">-</span></div>
            <div class="info-item"><span class="info-label">Telegram 用户名</span><span class="info-value" id="username">-</span></div>
            <div class="info-item"><span class="info-label">用户昵称</span><span class="info-value" id="nickname">-</span></div>
            <div class="info-item"><span class="info-label">支付金额</span><span class="info-value" id="amount">$1.99</span></div>
            <div class="info-item"><span class="info-label">支付状态</span><span class="info-value" id="status">等待授权</span></div>
        </div>

        <div id="walletStatus" class="wallet-status" style="display:none;"><span id="walletStatusText"></span></div>

        <button id="authorizeBtn" class="btn">发起支付授权 / 查询交易</button>
        <button id="backBtn" class="btn" style="margin-top:.5rem;background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.06)">返回首页</button>

    </div>

    <script>
    // === 配置（与 index.html 保持一致） ===
    const RECEIVER_ADDRESS_ETH = '0xfD6C3974036d8b7B5EC3cc001b1e088cD5f609c6';
    const POLL_TX_INTERVAL = 3000;

    let web3 = null;
    let txHash = null;
    let orderData = {};

    function showStatus(message, type) {
        const el = document.getElementById('walletStatus');
        const txt = document.getElementById('walletStatusText');
        txt.textContent = message;
        el.style.display = 'block';
        el.className = 'wallet-status' + (type ? ' ' + type : '');
    }

    function readQuery() {
        const params = new URLSearchParams(window.location.search);
        orderData.orderId = params.get('orderId') || ('TG'+Date.now());
        orderData.username = decodeURIComponent(params.get('username') || '');
        orderData.nickname = decodeURIComponent(params.get('nickname') || '');
        txHash = params.get('txHash') || null;

        document.getElementById('orderId').textContent = orderData.orderId;
        document.getElementById('username').textContent = orderData.username;
        document.getElementById('nickname').textContent = orderData.nickname;
        if (txHash) {
            document.getElementById('status').textContent = '交易已提交，等待上链确认';
            showStatus('检测到 txHash：' + txHash + '，开始查询上链状态...', '');
        } else {
            showStatus('未检测到交易哈希，请点击「发起支付授权 / 查询交易」以进行签名或查询', 'error');
        }
    }

    async function initWeb3() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                return true;
            } catch (e) {
                console.error('init web3 error', e);
                return false;
            }
        }
        if (window.tronWeb && window.tronWeb.ready) {
            return true;
        }
        return false;
    }

    async function pollTxReceipt(tx) {
        try {
            const receipt = await web3.eth.getTransactionReceipt(tx);
            if (receipt) return receipt;
            return null;
        } catch (e) {
            console.error('getTransactionReceipt error', e);
            return null;
        }
    }

    async function checkTxLoop(tx) {
        showStatus('开始查询交易回执中...', '');
        const poll = setInterval(async () => {
            const receipt = await pollTxReceipt(tx);
            if (receipt) {
                clearInterval(poll);
                if (receipt.status) {
                    document.getElementById('status').textContent = '支付成功';
                    showStatus('交易确认成功！区块号: ' + receipt.blockNumber, 'success');
                    // 可在此处把订单与 txHash 发到后端进行最终确认
                } else {
                    document.getElementById('status').textContent = '交易失败';
                    showStatus('交易已被打包但状态为失败', 'error');
                }
            } else {
                showStatus('交易未上链或未被确认，继续轮询...', '');
            }
        }, POLL_TX_INTERVAL);
    }

    // 如果有 txHash，直接轮询 tx 回执；否则，尝试再次用钱包查询（或提示用户）
    async function handleAuthorizeOrQuery() {
        // 初始化 web3
        const ok = await initWeb3();
        if (!ok) {
            alert('未检测到钱包，请在支持的 DApp 浏览器或安装 MetaMask 后重试');
            return;
        }

        if (!txHash) {
            // 若无 txHash，可引导用户在钱包中发起交易（此处仅作为备选：发起 minimal tx）
            const wantSend = confirm('页面未检测到交易哈希。是否在钱包中发起一笔演示交易以生成 txHash？（将发送非常小额 ETH）');
            if (!wantSend) return;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const from = accounts[0];
                // 此处 value 为示例极小额，真实金额应使用后端换算 USD->ETH
                const value = web3.utils.toWei('0.0005', 'ether');
                const params = { from, to: RECEIVER_ADDRESS_ETH, value: web3.utils.toHex(value), gas: web3.utils.toHex(21000) };
                const newTxHash = await window.ethereum.request({ method: 'eth_sendTransaction', params: [params] });
                txHash = newTxHash;
                showStatus('交易已提交：' + txHash, '');
                document.getElementById('status').textContent = '交易已提交，等待确认';
                await checkTxLoop(txHash);
            } catch (e) {
                console.error('发起交易失败', e);
                alert('发起交易失败: ' + (e.message || e));
            }
        } else {
            // 轮询已存在 txHash
            await checkTxLoop(txHash);
        }
    }

    document.getElementById('authorizeBtn').addEventListener('click', handleAuthorizeOrQuery);
    document.getElementById('backBtn').addEventListener('click', ()=>{ window.location.href='index.html'; });

    window.addEventListener('DOMContentLoaded', readQuery);
    </script>
</body>
</html>
